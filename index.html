<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grade Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 
           Modern, responsive dark theme with improved UI
           Mobile-friendly with collapsible sidebar
           Better visual hierarchy and spacing
        */

        :root {
            --background-color: #121212;
            --sidebar-color: #1e1e1e;
            --accent-color: #4285f4;
            --accent-hover: #5c9aff;
            --text-color: #ffffff;
            --text-color-light: #e0e0e0;
            --text-muted: #888888;
            --border-color: #2a2a2a;
            --error-color: #f44336;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --transition-speed: 0.2s;
            --table-row-hover: #2c2f33;
            /* Improved grade color scheme */
            --A-plus-color: #00c853;
            --A-color: #2ecc71;
            --A-minus-color: #4caf50;
            --B-plus-color: #03a9f4;
            --B-color: #2196f3;
            --B-minus-color: #1976d2;
            --C-plus-color: #ffc107;
            --C-color: #ffa000;
            --C-minus-color: #ff8f00;
            --D-color: #ff5722;
            --F-color: #d32f2f;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background: var(--background-color);
            color: var(--text-color-light);
            display: flex;
            flex-direction: column;
            height: 100vh;
            line-height: 1.6;
        }

        header {
            background: var(--sidebar-color);
            color: var(--text-color);
            padding: 15px 20px;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 10px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header .title {
            flex: 1;
        }

        #container {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: calc(100vh - 120px); /* header + footer height */
        }

        /* SIDEBAR */
        #sidebar {
            width: 260px;
            background: var(--sidebar-color);
            color: var(--text-color);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            padding-bottom: 20px;
            transition: all var(--transition-speed);
        }

        #sidebar h2 {
            text-align: center;
            padding: 20px 0;
            margin: 0;
            font-size: 22px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px;
        }

        .sidebar-button-group.bottom-buttons {
            margin-top: auto;
        }

        #class-list {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
        }

        #class-list li {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background var(--transition-speed);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #class-list li:hover {
            background: rgba(255,255,255,0.05);
        }

        #class-list .active {
            background: rgba(66, 133, 244, 0.15);
            border-left: 3px solid var(--accent-color);
        }

        /* CONTENT */
        #content {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
        }

        .button {
            padding: 10px 16px;
            background: var(--accent-color);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            font-weight: 600;
            transition: all var(--transition-speed);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: inline-block;
        }

        .button:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .button.small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .button.accent {
            background: var(--error-color);
        }

        .button.accent:hover {
            background: #f55a4e;
        }

        .button.secondary {
            background: #3b3e42;
        }

        .button.secondary:hover {
            background: #4a4e54;
        }

        input[type="text"], input[type="number"], input[type="email"], input[type="password"], select, textarea {
            padding: 10px 12px;
            width: 100%;
            margin: 6px 0 16px 0;
            border: 1px solid #444;
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-color);
            background: #2c2f33;
            transition: border var(--transition-speed);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.25);
        }

        label {
            margin-bottom: 6px;
            display: block;
            font-weight: 600;
            color: var(--text-color);
        }

        section {
            margin-bottom: 30px;
            padding: 25px;
            background: #1e1e1e;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        h2, h3, h4 {
            color: var(--text-color);
            margin-top: 0;
            line-height: 1.3;
        }

        h2 {
            font-size: 26px;
            margin-bottom: 20px;
        }

        h3 {
            font-size: 22px;
            margin-bottom: 15px;
        }

        h4 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        p, li {
            color: var(--text-color-light);
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            table-layout: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        table, th, td {
            border: none;
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #333;
            vertical-align: top;
            color: var(--text-color-light);
            white-space: normal;
        }

        th {
            background: #252525;
            font-weight: 600;
            color: var(--text-color);
        }

        tr:hover {
            background-color: var(--table-row-hover);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Animate assignment row movement more clearly */
        tbody tr.move-animation {
            transition: transform 0.3s ease-in-out;
        }

        /* Excluded or dropped assignment row backgrounds */
        .excluded-manual {
            background-color: rgba(244, 67, 54, 0.15) !important;
        }

        .excluded-dropped {
            background-color: rgba(255, 152, 0, 0.15) !important;
        }

        .error {
            color: var(--error-color);
            font-weight: 600;
            margin-top: 10px;
            display: inline-block;
        }

        footer {
            text-align: center;
            padding: 15px 0;
            background: #1e1e1e;
            color: var(--text-muted);
            border-top: 1px solid var(--border-color);
        }

        #login-container {
            padding: 30px;
            max-width: 350px;
            margin: 100px auto;
            background: #1e1e1e;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        #admin-controls {
            margin-top: 20px;
            display: none;
            padding: 20px;
            background: #1e1e1e;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        /* Grade coloring - completely revised color gradient */
        .grade-a-plus {
            color: #00c853 !important; /* Bright green */
            font-weight: bold;
        }

        .grade-a {
            color: #2ecc71 !important; /* Green */
            font-weight: bold;
        }

        .grade-a-minus {
            color: #4caf50 !important; /* Light green */
        }

        .grade-b-plus {
            color: #cddc39 !important; /* Lime */
        }

        .grade-b {
            color: #ffeb3b !important; /* Yellow */
        }

        .grade-b-minus {
            color: #ffc107 !important; /* Amber */
        }

        .grade-c-plus {
            color: #ff9800 !important; /* Orange */
        }

        .grade-c {
            color: #ff7043 !important; /* Deep orange */
        }

        .grade-c-minus {
            color: #ff5722 !important; /* Red-orange */
        }

        .grade-d {
            color: #f44336 !important; /* Red */
        }

        .grade-f {
            color: #d32f2f !important; /* Deep red */
            font-weight: bold;
        }

        /* Mobile adjustments - improved responsive design */
        .mobile-only {
            display: none;
        }
        
        /* New chart styles */
        .chart-container {
            width: 100%;
            height: 350px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
        }
        
        .insight-card {
            background: #252525;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-left: 4px solid var(--accent-color);
            transition: transform 0.3s ease; /* Animation for cards */
        }
        
        .insight-card:hover {
            transform: translateY(-3px); /* Animation effect */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .insight-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        
        .personal-best {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease; /* Animation for cards */
        }
        
        .personal-best:hover {
            transform: scale(1.02); /* Slight scale effect on hover */
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        
        .personal-best::after {
            content: '🏆';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            opacity: 0.5;
            transition: all 0.3s ease; /* Trophy animation */
        }
        
        .personal-best:hover::after {
            opacity: 1;
            transform: translateY(-50%) rotate(10deg); /* Rotate trophy on hover */
        }
        
        .course-comparison {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .course-card {
            flex: 1 1 200px;
            background: #252525;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            position: relative; /* For absolute positioning of credit info */
        }
        
        .course-card:hover {
            transform: translateY(-3px);
        }
        
        .credit-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #333;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #ccc;
        }
        
        .course-name {
            font-weight: bold;
            margin-bottom: 8px;
            padding-right: 60px; /* Make room for credit badge */
        }
        
        .login-header {
            margin-bottom: 25px;
            color: var(--text-color);
        }
        
        .login-footer {
            margin-top: 25px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Status labels for assignments */
        .status-label {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 5px;
            font-weight: bold;
        }
        
        .status-excluded {
            background-color: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        .status-dropped {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }
        
        /* Grade without drops mini indicator */
        .grade-without-drops {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 5px;
            display: inline-block;
            padding: 2px 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            #sidebar {
                width: 220px;
            }

            .sidebar-button-group {
                margin: 15px;
            }
            
            #content {
                padding: 15px;
            }
            
            section {
                padding: 20px;
            }
            
            .button {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .course-comparison {
                flex-direction: column;
            }
            
            .course-card {
                flex: none;
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            body {
                overflow-x: hidden;
                width: 100%;
            }
            
            .mobile-only {
                display: block;
                font-size: 24px;
                cursor: pointer;
                padding: 0 10px;
            }
            
            #sidebar {
                position: fixed;
                width: 100%;
                height: auto;
                z-index: 1001;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                max-height: 80vh;
                overflow-y: auto;
                top: 0;
            }
            
            #sidebar.active {
                transform: translateY(0);
                display: block !important;
            }
            
            #container {
                flex-direction: column;
                width: 100%;
                overflow-x: hidden;
            }
            
            #content {
                margin-left: 0 !important;
                padding: 15px;
                width: 100%;
                box-sizing: border-box;
            }
            
            #sidebar h2 {
                display: block;
                padding: 15px 0;
            }
            
            .mobile-close {
                position: absolute;
                top: 15px;
                right: 20px;
                font-size: 24px;
                cursor: pointer;
                color: var(--text-color);
                display: block;
            }
            
            /* Improved mobile action buttons */
            .action-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                justify-content: flex-end;
                padding: 8px 8px 8px 50% !important;
            }
            
            td.action-buttons button {
                margin: 0 !important;
                padding: 6px !important;
                font-size: 11px !important;
                min-width: 0 !important;
                flex: 0 0 auto !important;
                width: auto !important;
            }
            .drag-handle { cursor: move; margin-left: 8px; }
            tr.drag-over { outline: 2px dashed var(--accent-color); }
            tr.dragging { opacity: 0.5; }
            
            /* Make tables responsive on mobile */
            table, thead, tbody, th, td, tr {
                display: block;
            }
            
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            tr {
                margin-bottom: 15px;
                border-radius: 8px;
                background: #1a1a1a;
                padding: 10px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }
            
            td {
                border: none;
                position: relative;
                padding: 8px 8px 8px 50%;
                text-align: right;
                border-bottom: 1px solid #333;
            }
            
            td:last-child {
                border-bottom: none;
            }
            
            td:before {
                position: absolute;
                left: 10px;
                width: 45%;
                white-space: nowrap;
                font-weight: bold;
                text-align: left;
            }
            
            /* Add labels for mobile table view */
            td:nth-of-type(1):before { content: "Name"; }
            td:nth-of-type(2):before { content: "Category"; }
            td:nth-of-type(3):before { content: "Score"; }
            td:nth-of-type(4):before { content: "Total"; }
            td:nth-of-type(5):before { content: "Percentage"; }
            td:nth-of-type(6):before { content: "Actions"; }
        }
        
        /* Don't show mobile close button on desktop */
        @media (min-width: 601px) {
            .mobile-close {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="title">Grade Tracker</div>
        <div id="mobile-menu-toggle" class="mobile-only">☰</div>
        <div style="font-size:14px;">built by Reuven Sash</div>
    </header>
    <div id="login-container" style="display:none;">
        <div class="login-header">
            <h2 style="font-size: 28px; margin-bottom: 10px;">Grade Tracker</h2>
            <p style="color: var(--text-muted);">Track your academic progress with ease</p>
        </div>
        <label>Email</label>
        <input type="email" id="login-email" placeholder="Enter your email" />
        <label>Password</label>
        <input type="password" id="login-password" placeholder="Enter your password" />
        <button id="login-button" class="button" style="width: 100%; margin-top: 10px;">Sign In</button>
        <div id="login-error" class="error"></div>
        <div class="login-footer">
            <p>Built by Reuven Sash</p>
        </div>
    </div>
    <div id="container">
        <div id="sidebar" style="display:none;">
            <div class="mobile-close" id="mobile-menu-close">×</div>
            <h2>Your Classes</h2>
            <div class="sidebar-button-group">
                <button id="add-class-btn" class="button">Add New Class</button>
                <button id="gpa-calculator-btn" class="button secondary">GPA Calculator</button>
            </div>
            <ul id="class-list"></ul>
            <div class="sidebar-button-group bottom-buttons">
                <button id="export-data-btn" class="button small">Export JSON</button>
                <button id="export-csv-btn" class="button small">Export CSV</button>
                <button id="import-data-btn" class="button small">Import Data</button>
                <input type="file" id="import-file-input" accept=".json,.csv" style="display:none;">
                <button id="logout-button" class="button accent small">Logout</button>
            </div>
            <div id="admin-controls">
                <h3>Admin Controls</h3>
                <label for="user-select">Select User</label>
                <select id="user-select"></select>
                <button id="switch-user-button" class="button">Load Selected User</button>
            </div>
        </div>

        <div id="content" style="display:none;"></div>
    </div>
    <footer>
        Built by Reuven Sash
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        // ===== Firebase Initialization =====
        const firebaseConfig = {
            apiKey: "AIzaSyCxpYrGFjIlHQovBD-44riu96AZ50L3YUo",
            authDomain: "yof-tracker.firebaseapp.com",
            projectId: "yof-tracker",
            storageBucket: "yof-tracker.firebasestorage.app",
            messagingSenderId: "867007397664",
            appId: "1:867007397664:web:9cbccc410443d6581a2145"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let docRef = null;
        let classes = [];
        let semesters = [];
        let dataLoaded = false;
        let currentUser = null;
        let isAdmin = false;
        // Arrays to store historical grade data and personal bests
        let gradeHistory = [];
        let personalBests = [];
        // Chart objects
        let gradeChart = null;

        // ===== Event Handlers =====
        document.getElementById('add-class-btn').addEventListener('click', function() {
            addClass();
        });

        document.getElementById('gpa-calculator-btn').addEventListener('click', function() {
            renderGPACalculator();
        });

        // Mobile menu toggle
        document.getElementById('mobile-menu-toggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('active');
        });

        document.getElementById('mobile-menu-close').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('active');
        });

        // Hide sidebar when clicking on content area in mobile view
        document.getElementById('content').addEventListener('click', function() {
            if(window.innerWidth <= 600) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('active');
            }
        });
        
        // Close sidebar when a class is selected on mobile
        document.addEventListener('click', function(e) {
            if (e.target.closest('#class-list li') && window.innerWidth <= 600) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('active');
            }
        });

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                try {
                  const rolesDoc = await db.collection('adminInfo').doc('roles').get();
                  if (rolesDoc.exists) {
                    const data = rolesDoc.data();
                    isAdmin = Array.isArray(data.adminUsers) && data.adminUsers.includes(user.uid);
                  } else {
                    isAdmin = false;
                  }
                } catch (err) {
                  console.error("Error checking admin roles:", err);
                  isAdmin = false;
                }

                if (isAdmin) {
                    showAdminUI();
                } else {
                    docRef = db.collection('gradeTracker').doc(user.uid);
                    document.getElementById('admin-controls').style.display = 'none';
                    await loadDataFromFirestore();
                    showNormalUserUI();
                }
            } else {
                currentUser = null;
                docRef = null;
                showLoginUI();
            }
        });

        function showLoginUI() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('content').style.display = 'none';
            document.getElementById('admin-controls').style.display = 'none';
        }

        function showNormalUserUI() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('content').style.display = 'block';
        }

        async function showAdminUI() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('content').style.display = 'block';
            document.getElementById('admin-controls').style.display = 'block';

            try {
                const snapshot = await db.collection('gradeTracker').get();
                const userSelect = document.getElementById('user-select');
                userSelect.innerHTML = '<option value="">--Select a user--</option>';
                snapshot.forEach(doc => {
                  const opt = document.createElement('option');
                  opt.value = doc.id;
                  opt.textContent = doc.id;
                  userSelect.appendChild(opt);
                });
            } catch (error) {
                console.error("Error loading users:", error);
                alert("Failed to load users: " + error.message);
            }
        }

        document.getElementById('login-button').onclick = async function() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                document.getElementById('login-error').textContent = error.message;
            }
        };

        document.getElementById('logout-button').onclick = async function() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Failed to sign out: " + error.message);
            }
        };

        document.getElementById('switch-user-button').onclick = async function() {
            const selectedUserId = document.getElementById('user-select').value;
            if (!selectedUserId) {
                alert('Please select a user');
                return;
            }
            docRef = db.collection('gradeTracker').doc(selectedUserId);
            await loadDataFromFirestore();
        };

        async function loadDataFromFirestore() {
            try {
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    classes = data.classes || [];
                    semesters = data.semesters || [];
                    gradeHistory = data.gradeHistory || [];
                    personalBests = data.personalBests || [];
                } else {
                    classes = [];
                    semesters = [];
                    gradeHistory = [];
                    personalBests = [];
                    // Initialize document with empty data
                    await docRef.set({ 
                        classes: [], 
                        semesters: [],
                        gradeHistory: [],
                        personalBests: []
                    });
                }
                dataLoaded = true;
                renderClassList();
                if (classes.length > 0) {
                    const firstClassLi = document.querySelector('#class-list li');
                    if (firstClassLi) firstClassLi.classList.add('active');
                    renderClassContent(0);
                } else {
                    document.getElementById('content').innerHTML = `
                        <h2>Welcome to Grade Tracker!</h2>
                        <section>
                            <p>Get started by adding your first class using the "Add New Class" button in the sidebar.</p>
                            <p>This app will help you:</p>
                            <ul>
                                <li>Track assignments and calculate your current grade</li>
                                <li>View historical grade progress</li>
                                <li>Get insights about your academic performance</li>
                                <li>Track personal achievements and improvements</li>
                                <li>Compare performance across different courses</li>
                            </ul>
                            <div style="margin-top: 20px;">
                                <button class="button" onclick="addClass()">Add Your First Class</button>
                            </div>
                        </section>
                    `;
                }
            } catch (error) {
                console.error("Error loading data:", error);
                alert("Failed to load data: " + error.message);
            }
        }

        async function saveData() {
            if (!dataLoaded || !docRef) return;
            try {
                // Record snapshot for grade history when saving - but ONLY if there's a real grade change
                // Don't create "Manual Save" entries unless something actually changed
                let shouldRecord = true;
                
                // Check if there's a recent "Manual Save" entry within the last few seconds
                if (gradeHistory && gradeHistory.length > 0) {
                    const recentManualSaves = gradeHistory.filter(entry => 
                        entry.eventType === "Manual Save" && 
                        (new Date() - new Date(entry.timestamp)) < 5000); // within 5 seconds
                    
                    if (recentManualSaves.length > 0) {
                        shouldRecord = false; // Skip recording for rapid consecutive saves
                    }
                }
                
                if (shouldRecord) {
                    recordGradeSnapshot("Manual Save");
                }
                
                await docRef.set({ 
                    classes, 
                    semesters,
                    gradeHistory,
                    personalBests
                });
            } catch (error) {
                console.error("Error saving data:", error);
                alert("Failed to save data: " + error.message);
            }
        }
        
        // Function to record a snapshot of current grades for the historical graph
        function recordGradeSnapshot(eventType, details = {}) {
            const timestamp = new Date();
            
            // For each class, calculate the current grade and record it
            classes.forEach((cls, index) => {
                // Calculate the current grade
                const gradeData = calculateCurrentGrade(cls);
                
                if (gradeData && gradeData.finalGrade > 0) {
                    // Check if this would be a duplicate grade (avoid redundant entries)
                    const isDuplicate = hasRecentDuplicateGrade(index, gradeData.finalGrade, eventType);
                    
                    if (!isDuplicate) {
                        // Create snapshot object
                        const snapshot = {
                            timestamp: timestamp,
                            classId: index,
                            className: cls.name,
                            grade: gradeData.finalGrade,
                            eventType: eventType,
                            details: details
                        };
                        
                        // Initialize if not exists
                        if (!gradeHistory) gradeHistory = [];
                        
                        // Add to history
                        gradeHistory.push(snapshot);
                        
                        // Check for personal bests
                        checkForPersonalBests(cls, index, gradeData.finalGrade);
                    }
                }
            });
            
            // Limit history size (keep last 100 entries)
            if (gradeHistory && gradeHistory.length > 100) {
                gradeHistory = gradeHistory.slice(-100);
            }
        }

        // Helper to parse timestamps stored in various formats
        function parseTimestamp(ts) {
            if (ts instanceof Date) return ts;
            if (ts && typeof ts === 'object' && typeof ts.seconds === 'number') {
                return new Date(ts.seconds * 1000);
            }
            return new Date(ts);
        }

        // Helper function to calculate current grade for a class
        function calculateCurrentGrade(cls) {
            const categoryGrades = {};
            cls.categories.forEach((cat, index) => {
                categoryGrades[index] = [];
            });

            // Get assignments to drop
            const droppedAssignments = findAssignmentsToBeDropped(cls);
            const droppedSet = new Set(droppedAssignments);

            cls.assignments.forEach((assignment, index) => {
                if (
                    !assignment.exclude && 
                    !droppedSet.has(index) && 
                    assignment.score !== null && 
                    assignment.total !== null
                ) {
                    categoryGrades[assignment.categoryIndex].push((assignment.score / assignment.total) * 100);
                }
            });

            let totalWeightedScore = 0;
            let totalWeights = 0;

            cls.categories.forEach((cat, index) => {
                const grades = categoryGrades[index];
                if (grades && grades.length > 0) {
                    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                    totalWeightedScore += (average * cat.weight);
                    totalWeights += cat.weight;
                }
            });

            const finalGrade = totalWeights > 0 ? totalWeightedScore / totalWeights : 0;
            
            return {
                finalGrade,
                totalWeightedScore,
                totalWeights
            };
        }
        
        // Helper to check if a recent duplicate grade exists
        function hasRecentDuplicateGrade(classId, grade, eventType) {
            if (!gradeHistory || gradeHistory.length === 0) return false;
            
            const recentEntries = gradeHistory.filter(entry => 
                entry.classId === classId &&
                Math.abs(entry.grade - grade) < 0.001 && // Same grade
                entry.eventType === eventType && // Same event type 
                (new Date() - new Date(entry.timestamp)) < 5000); // within 5 seconds
                
            return recentEntries.length > 0;
        }
        
        // Function to check for and record personal bests
        function checkForPersonalBests(cls, classIndex, currentGrade) {
            // Initialize if not exists
            if (!personalBests) personalBests = [];
            
            const existingBestForClass = personalBests.find(pb => 
                pb.type === 'highest_overall' && pb.classId === classIndex);
            
            // Check for new overall highest grade
            if (!existingBestForClass || currentGrade > existingBestForClass.value) {
                // Remove old best if exists
                if (existingBestForClass) {
                    personalBests = personalBests.filter(pb => 
                        !(pb.type === 'highest_overall' && pb.classId === classIndex));
                }
                
                // Add new best
                personalBests.push({
                    type: 'highest_overall',
                    classId: classIndex,
                    className: cls.name,
                    value: currentGrade,
                    timestamp: new Date(),
                    description: `Highest overall grade in ${cls.name}`
                });
            }
            
            // Check for category bests
            cls.categories.forEach((cat, catIndex) => {
                const gradesInCategory = cls.assignments
                    .filter(a => 
                        a.categoryIndex === catIndex && 
                        !a.exclude && 
                        a.score !== null && 
                        a.total !== null
                    );
                
                if (gradesInCategory.length > 0) {
                    // Calculate average for this category
                    const catGrades = gradesInCategory.map(a => (a.score / a.total) * 100);
                    const catAverage = catGrades.reduce((a, b) => a + b, 0) / catGrades.length;
                    
                    // Check if this is a new best for this category
                    const existingCatBest = personalBests.find(pb => 
                        pb.type === 'highest_category' && 
                        pb.classId === classIndex && 
                        pb.categoryId === catIndex);
                    
                    if (!existingCatBest || catAverage > existingCatBest.value) {
                        // Remove old best if exists
                        if (existingCatBest) {
                            personalBests = personalBests.filter(pb => 
                                !(pb.type === 'highest_category' && 
                                  pb.classId === classIndex && 
                                  pb.categoryId === catIndex));
                        }
                        
                        // Add new best
                        personalBests.push({
                            type: 'highest_category',
                            classId: classIndex,
                            className: cls.name,
                            categoryId: catIndex,
                            categoryName: cat.name,
                            value: catAverage,
                            timestamp: new Date(),
                            description: `Highest average in ${cat.name} for ${cls.name}`
                        });
                    }
                    
                    // Check for best individual assignment
                    const bestAssignment = gradesInCategory.reduce((best, current) => {
                        const currentPercent = (current.score / current.total) * 100;
                        return (currentPercent > best.percent) ? 
                            { percent: currentPercent, assignment: current } : 
                            best;
                    }, { percent: 0, assignment: null });
                    
                    if (bestAssignment.assignment) {
                        const existingAssignmentBest = personalBests.find(pb => 
                            pb.type === 'highest_assignment' && 
                            pb.classId === classIndex && 
                            pb.categoryId === catIndex);
                        
                        if (!existingAssignmentBest || bestAssignment.percent > existingAssignmentBest.value) {
                            // Remove old best if exists
                            if (existingAssignmentBest) {
                                personalBests = personalBests.filter(pb => 
                                    !(pb.type === 'highest_assignment' && 
                                      pb.classId === classIndex && 
                                      pb.categoryId === catIndex));
                            }
                            
                            // Add new best
                            personalBests.push({
                                type: 'highest_assignment',
                                classId: classIndex,
                                className: cls.name,
                                categoryId: catIndex,
                                categoryName: cat.name,
                                assignmentName: bestAssignment.assignment.name,
                                value: bestAssignment.percent,
                                timestamp: new Date(),
                                description: `Highest score on ${bestAssignment.assignment.name} in ${cls.name}`
                            });
                        }
                    }
                }
            });
            
            // Check for streak (consecutive assignments above 90%)
            let currentStreak = 0;
            let maxStreak = 0;
            
            // Sort assignments by date added (we're using index as a proxy for time)
            const sortedAssignments = [...cls.assignments]
                .filter(a => !a.exclude && a.score !== null && a.total !== null)
                .sort((a, b) => cls.assignments.indexOf(a) - cls.assignments.indexOf(b));
            
            for (const assignment of sortedAssignments) {
                const percent = (assignment.score / assignment.total) * 100;
                if (percent >= 90) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            }
            
            // Check if this is a new best streak
            if (maxStreak >= 3) { // Only count streaks of 3 or more
                const existingStreak = personalBests.find(pb => 
                    pb.type === 'best_streak' && pb.classId === classIndex);
                
                if (!existingStreak || maxStreak > existingStreak.value) {
                    // Remove old streak if exists
                    if (existingStreak) {
                        personalBests = personalBests.filter(pb => 
                            !(pb.type === 'best_streak' && pb.classId === classIndex));
                    }
                    
                    // Add new streak
                    personalBests.push({
                        type: 'best_streak',
                        classId: classIndex,
                        className: cls.name,
                        value: maxStreak,
                        timestamp: new Date(),
                        description: `${maxStreak} assignments in a row above 90% in ${cls.name}`
                    });
                }
            }
        }

        /*============================
          CLASS LIST & MAIN CONTENT
        ============================*/

        function renderClassList() {
            const classList = document.getElementById('class-list');
            classList.innerHTML = '';
            classes.forEach((cls, index) => {
                const li = document.createElement('li');
                li.textContent = cls.name;
                li.onclick = () => {
                    document.querySelectorAll('#class-list li').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');
                    renderClassContent(index);
                };
                classList.appendChild(li);
            });
        }

        function renderClassContent(classIndex) {
            const content = document.getElementById('content');
            const cls = classes[classIndex];
            if (!cls.categories) cls.categories = [];

            // Check if categories total 100
            let totalWeight = cls.categories.reduce((sum, cat) => sum + Number(cat.weight), 0);
            let categoryWarning = '';
            if (totalWeight !== 100 && cls.categories.length > 0) {
                categoryWarning = `
                    <p class="error">
                        Warning: Categories total ${totalWeight}%. They should total 100% for accurate final grading.
                    </p>
                `;
            }

            content.innerHTML = `
                <h2>${cls.name}</h2>
                <div style="margin-bottom:20px;" class="button-group">
                    <button class="button" onclick="editClass(${classIndex})">Edit Class</button>
                    <button class="button accent small" onclick="deleteClass(${classIndex})">Delete</button>
                </div>
                
                <section id="grade-summary-section">
                    <h3>Current Grade</h3>
                    <div id="grade-summary"></div>
                </section>
                
                <section>
                    <h3>Assignments</h3>
                    <div id="assignment-list"></div>
                    <button class="button" style="margin-top:15px;" onclick="addAssignment(${classIndex})">Add Assignment</button>
                    <span id="assignment-error" class="error"></span>
                </section>
                
                <section>
                    <h3>Grade History</h3>
                    <div class="chart-container">
                        <canvas id="gradeHistoryChart"></canvas>
                    </div>
                </section>
                
                <section>
                    <h3>Smart Insights</h3>
                    <div id="grade-insights"></div>
                </section>
                
                <section>
                    <h3>Personal Bests</h3>
                    <div id="personal-bests"></div>
                </section>
                
                <section>
                    <h3>Categories</h3>
                    ${categoryWarning}
                    <div id="category-list"></div>
                    <div style="margin-top:15px;">
                        <button class="button small" onclick="addCategory(${classIndex})">Add Category</button>
                    </div>
                    <span id="category-error" class="error"></span>
                </section>
            `;

            renderCategories(classIndex);
            renderAssignments(classIndex);
            calculateGrade(classIndex);
        }

        function addClass() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>Grade Tracker</h2>
                <section>
                    <h3>Add New Class</h3>
                    <label>Class Name</label>
                    <input type="text" id="new-class-name" placeholder="e.g., Mathematics">
                    <label>Credits (default is 1)</label>
                    <input type="number" id="new-class-credits" placeholder="e.g., 1" min="0.1" step="0.1">
                    <div style="margin-top:20px;">
                        <button class="button" onclick="saveNewClass()">Save</button>
                        <button class="button accent" onclick="renderClassContentOnCancel()">Cancel</button>
                    </div>
                </section>
            `;
        }

        function renderClassContentOnCancel() {
          if (classes.length > 0) {
              renderClassContent(0);
          } else {
              document.getElementById('content').innerHTML = '<h2>Welcome!</h2><p>Get started by adding your first class using the "Add New Class" button.</p>';
          }
        }

        async function saveNewClass() {
            const className = document.getElementById('new-class-name').value.trim();
            let classCredits = parseFloat(document.getElementById('new-class-credits').value);
            if (className === '') {
                alert('Please enter a valid class name.');
                return;
            }
            if (isNaN(classCredits) || classCredits <= 0) {
                classCredits = 1;
            }
            classes.push({
                name: className,
                credits: classCredits,
                categories: [],
                assignments: [],
                finalCategoryIndex: null
            });
            await saveData();
            renderClassList();
            const newIndex = classes.length - 1;
            document.querySelectorAll('#class-list li').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('#class-list li')[newIndex].classList.add('active');
            renderClassContent(newIndex);
        }

        function editClass(classIndex) {
            const cls = classes[classIndex];
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>Edit Class</h2>
                <section>
                    <label>Class Name</label>
                    <input type="text" id="edit-class-name" value="${cls.name}">
                    <label>Credits (default is 1)</label>
                    <input type="number" id="edit-class-credits" value="${cls.credits}" min="0.1" step="0.1">
                    <div style="margin-top:20px;">
                        <button class="button" onclick="saveEditedClass(${classIndex})">Save</button>
                        <button class="button accent" onclick="renderClassContent(${classIndex})">Cancel</button>
                    </div>
                </section>
            `;
        }

        async function saveEditedClass(classIndex) {
            const cls = classes[classIndex];
            const newName = document.getElementById('edit-class-name').value.trim();
            let newCredits = parseFloat(document.getElementById('edit-class-credits').value);
            if (newName === '') {
                alert('Please enter a valid class name.');
                return;
            }
            if (isNaN(newCredits) || newCredits <= 0) {
                newCredits = 1;
            }
            cls.name = newName;
            cls.credits = newCredits;
            await saveData();
            renderClassList();
            renderClassContent(classIndex);
        }

        async function deleteClass(classIndex) {
            if (confirm('Are you sure you want to delete this class?')) {
                classes.splice(classIndex, 1);
                await saveData();
                renderClassList();
                if (classes.length > 0) {
                    document.querySelectorAll('#class-list li')[0].classList.add('active');
                    renderClassContent(0);
                } else {
                    document.getElementById('content').innerHTML = '<h2>Welcome!</h2><p>Get started by adding your first class using the "Add New Class" button.</p>';
                }
            }
        }

        /*============================
          CATEGORIES
        ============================*/

        function addCategory(classIndex) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';
            categoryDiv.style.backgroundColor = '#222';
            categoryDiv.style.padding = '15px';
            categoryDiv.style.borderRadius = '8px';
            categoryDiv.style.marginBottom = '15px';

            categoryDiv.innerHTML = `
                <label>Category Name</label>
                <input type="text" placeholder="e.g., Quizzes">
                <label>Weight (%)</label>
                <input type="number" placeholder="e.g., 20" min="0" max="100">
                <label>Number of Lowest Grades to Drop</label>
                <input type="number" placeholder="e.g., 1" min="0" step="1">
                <div style="margin-top:15px;">
                    <button class="button small" onclick="saveCategory(${classIndex}, this)">Save</button>
                    <button class="button accent small" onclick="renderCategories(${classIndex})">Cancel</button>
                </div>
            `;
            document.getElementById('category-list').appendChild(categoryDiv);
        }

        async function saveCategory(classIndex, button) {
            const cls = classes[classIndex];
            const categoryDiv = button.parentElement.parentElement;
            const inputs = categoryDiv.querySelectorAll('input');
            const name = inputs[0].value.trim();
            const weight = Number(inputs[1].value);
            let numToDrop = parseInt(inputs[2].value, 10);

            if (name === '' || isNaN(weight) || weight <= 0) {
                alert('Please enter valid category details.');
                return;
            }

            if (isNaN(numToDrop) || numToDrop < 0) {
                numToDrop = 0;
            }

            const totalWeight = cls.categories.reduce((sum, cat) => sum + Number(cat.weight), 0) + weight;
            if (totalWeight > 100) {
                alert('Total weight exceeds 100%. Adjust the weights.');
                return;
            }

            cls.categories.push({
                name: name,
                weight: weight,
                numToDrop: numToDrop
            });
            await saveData();
            renderCategories(classIndex);
            calculateGrade(classIndex);
        }

        function renderCategories(classIndex) {
            const cls = classes[classIndex];
            const categoryList = document.getElementById('category-list');
            categoryList.innerHTML = '';
            if (!cls.categories) cls.categories = [];
            
            if (cls.categories.length === 0) {
                categoryList.innerHTML = '<p>No categories added yet. Add a category to organize your assignments.</p>';
                return;
            }
            
            cls.categories.forEach((cat, index) => {
                const div = document.createElement('div');
                div.className = 'category';
                div.style.backgroundColor = '#222';
                div.style.padding = '15px';
                div.style.borderRadius = '8px';
                div.style.marginBottom = '15px';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 16px;">${cat.name}</strong>
                            <p style="margin: 5px 0;">Weight: ${cat.weight}% 
                            ${cat.numToDrop > 0 ? `<em>(Drop Lowest ${cat.numToDrop})</em>` : ''}</p>
                        </div>
                        <div>
                            <button class="button small" onclick="editCategory(${classIndex}, ${index})">Edit</button>
                            <button class="button accent small" onclick="deleteCategory(${classIndex}, ${index})">Delete</button>
                        </div>
                    </div>
                `;
                categoryList.appendChild(div);
            });
        }

        function editCategory(classIndex, categoryIndex) {
            const cls = classes[classIndex];
            const cat = cls.categories[categoryIndex];

            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';
            categoryDiv.style.backgroundColor = '#222';
            categoryDiv.style.padding = '15px';
            categoryDiv.style.borderRadius = '8px';
            categoryDiv.style.marginBottom = '15px';

            categoryDiv.innerHTML = `
                <label>Category Name</label>
                <input type="text" value="${cat.name}">
                <label>Weight (%)</label>
                <input type="number" min="0" max="100" value="${cat.weight}">
                <label>Number of Lowest Grades to Drop</label>
                <input type="number" min="0" step="1" value="${cat.numToDrop || 0}">
                <div style="margin-top:15px;">
                    <button class="button small" onclick="saveEditedCategory(${classIndex}, ${categoryIndex}, this)">Save</button>
                    <button class="button accent small" onclick="renderCategories(${classIndex})">Cancel</button>
                </div>
            `;

            const categoryList = document.getElementById('category-list');
            categoryList.replaceChild(categoryDiv, categoryList.children[categoryIndex]);
        }

        async function saveEditedCategory(classIndex, categoryIndex, button) {
            const cls = classes[classIndex];
            const cat = cls.categories[categoryIndex];
            const categoryDiv = button.parentElement.parentElement;
            const inputs = categoryDiv.querySelectorAll('input');
            const name = inputs[0].value.trim();
            const weight = Number(inputs[1].value);
            let numToDrop = parseInt(inputs[2].value, 10);

            if (name === '' || isNaN(weight) || weight <= 0) {
                alert('Please enter valid category details.');
                return;
            }

            if (isNaN(numToDrop) || numToDrop < 0) {
                numToDrop = 0;
            }

            const totalWeight = cls.categories.reduce((sum, c, i) => sum + (i !== categoryIndex ? Number(c.weight) : 0), 0) + weight;
            if (totalWeight > 100) {
                alert('Total weight exceeds 100%. Adjust the weights.');
                return;
            }

            cat.name = name;
            cat.weight = weight;
            cat.numToDrop = numToDrop;
            await saveData();
            renderCategories(classIndex);
            calculateGrade(classIndex);
        }

        async function deleteCategory(classIndex, categoryIndex) {
            if (confirm('Deleting this category will also delete all associated assignments. Proceed?')) {
                const cls = classes[classIndex];
                cls.categories.splice(categoryIndex, 1);

                // Remove assignments from this category
                cls.assignments = cls.assignments.filter(a => a.categoryIndex !== categoryIndex);

                // Re-index other assignments
                cls.assignments.forEach(a => {
                    if (a.categoryIndex > categoryIndex) a.categoryIndex--;
                });

                if (cls.finalCategoryIndex === categoryIndex) {
                    cls.finalCategoryIndex = null;
                } else if (cls.finalCategoryIndex > categoryIndex) {
                    cls.finalCategoryIndex--;
                }
                await saveData();
                renderCategories(classIndex);
                renderAssignments(classIndex);
                calculateGrade(classIndex);
            }
        }

        /*============================
          ASSIGNMENTS
        ============================*/

        function addAssignment(classIndex) {
            const cls = classes[classIndex];
            if (cls.categories.length === 0) {
                alert('Please add at least one category first.');
                return;
            }
            const categoryOptions = cls.categories.map((cat, index) => `<option value="${index}">${cat.name}</option>`).join('');
            const assignmentHTML = `
                <div class="assignment" style="background-color: #222; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <label>Assignment Name</label>
                    <input type="text" placeholder="e.g., Quiz 1">
                    <label>Category</label>
                    <select>
                        ${categoryOptions}
                    </select>
                    <label>Score (or leave blank if incomplete) e.g. 18/25</label>
                    <input type="text" placeholder="e.g., 18/25">
                    <label style="margin-top:10px;">
                        <input type="checkbox"> Exclude from Grade
                    </label>
                    <div style="margin-top:15px;">
                        <button class="button small" onclick="saveAssignment(${classIndex}, this)">Save</button>
                        <button class="button accent small" onclick="renderAssignments(${classIndex})">Cancel</button>
                    </div>
                </div>
            `;
            document.getElementById('assignment-list').insertAdjacentHTML('beforeend', assignmentHTML);
        }

        async function saveAssignment(classIndex, button) {
            const cls = classes[classIndex];
            const assignmentDiv = button.parentElement.parentElement;
            const inputs = assignmentDiv.querySelectorAll('input');
            const selects = assignmentDiv.querySelectorAll('select');
            const name = inputs[0].value.trim();
            const categoryIndex = Number(selects[0].value);
            const gradeInput = inputs[1].value.trim();
            const exclude = inputs[2].checked;

            let score = null;
            let total = null;
            if (gradeInput && gradeInput.includes('/')) {
                const parts = gradeInput.split('/');
                score = Number(parts[0]);
                total = Number(parts[1]);
                if (isNaN(score) || isNaN(total) || total === 0) {
                    alert('Invalid score format. Please use format like "18/25".');
                    return;
                }
            }

            if (name === '') {
                alert('Please enter a valid assignment name.');
                return;
            }

            cls.assignments.push({
                name: name,
                categoryIndex: categoryIndex,
                score: score,
                total: total,
                exclude: exclude,
            });
            
            // Record grade snapshot when adding new assignment
            recordGradeSnapshot("New Assignment", {
                assignmentName: name,
                score: score,
                total: total,
                category: cls.categories[categoryIndex].name
            });
            
            await saveData();
            renderAssignments(classIndex);
            calculateGrade(classIndex);
        }

        function renderAssignments(classIndex) {
            const cls = classes[classIndex];
            const assignmentList = document.getElementById('assignment-list');
            assignmentList.innerHTML = '';
            if (!cls.assignments || cls.assignments.length === 0) {
                assignmentList.innerHTML = '<p>No assignments added yet.</p>';
                return;
            }

            // Calculate original grade without drops for info
            const assignmentsToBeDropped = findAssignmentsToBeDropped(cls);
            const wouldBeDropped = new Set(assignmentsToBeDropped);
            
            // Calculate difference between with and without drops
            let originalGrade = 0;
            let dropAdjustedGrade = 0;
            let gradeDifference = 0;
            
            if (assignmentsToBeDropped.length > 0) {
                const withoutDropsData = calculateGradeData(cls, []);
                const withDropsData = calculateGradeData(cls, assignmentsToBeDropped);
                
                originalGrade = withoutDropsData.finalGrade.toFixed(2);
                dropAdjustedGrade = withDropsData.finalGrade.toFixed(2);
                gradeDifference = (withDropsData.finalGrade - withoutDropsData.finalGrade).toFixed(2);
            }

            const table = document.createElement('table');
            let thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Score</th>
                    <th>Total</th>
                    <th>Percentage</th>
                    <th>Actions</th>
                </tr>
            `;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);


            cls.assignments.forEach((assignment, index) => {
                // Ensure the categoryIndex is valid
                if (assignment.categoryIndex >= cls.categories.length) {
                    assignment.categoryIndex = 0; // Reset to first category if invalid
                }
                
                const catName = cls.categories[assignment.categoryIndex]?.name || 'Unknown';
                let percentage = '';
                let gradeClass = '';
                
                if (assignment.score !== null && assignment.total !== null) {
                    const pct = (assignment.score / assignment.total) * 100;
                    percentage = pct.toFixed(2) + '%';
                    
                    // Add grade coloring
                    if (pct >= 96.5) gradeClass = 'grade-a-plus';
                    else if (pct >= 92.5) gradeClass = 'grade-a';
                    else if (pct >= 89.5) gradeClass = 'grade-a-minus';
                    else if (pct >= 86.5) gradeClass = 'grade-b-plus';
                    else if (pct >= 82.5) gradeClass = 'grade-b';
                    else if (pct >= 79.5) gradeClass = 'grade-b-minus';
                    else if (pct >= 76.5) gradeClass = 'grade-c-plus';
                    else if (pct >= 72.5) gradeClass = 'grade-c';
                    else if (pct >= 69.5) gradeClass = 'grade-c-minus';
                    else if (pct >= 64.5) gradeClass = 'grade-d';
                    else gradeClass = 'grade-f';
                } else {
                    percentage = '<em>Incomplete</em>';
                }

                const tr = document.createElement('tr');
                
                tr.setAttribute("draggable", "true");
                tr.dataset.index = index;
                // Status labels for clarity
                let statusLabel = '';
                
                // Exclude / dropped highlight
                if (assignment.exclude) {
                    tr.classList.add('excluded-manual');
                    statusLabel = '<span class="status-label status-excluded">Excluded</span>';
                } else if (wouldBeDropped.has(index)) {
                    tr.classList.add('excluded-dropped');
                    statusLabel = '<span class="status-label status-dropped">Dropped</span>';
                }


                tr.innerHTML = `
                    <td>${assignment.name} ${statusLabel}</td>
                    <td>${catName}</td>
                    <td>${assignment.score === null ? '—' : assignment.score}</td>
                    <td>${assignment.total === null ? '—' : assignment.total}</td>
                    <td class="${gradeClass}">${percentage}</td>
                    <td class="action-buttons">
                        <button class="button small" onclick="editAssignment(${classIndex}, ${index})">Edit</button>
                        <button class="button accent small" onclick="deleteAssignment(${classIndex}, ${index})">Delete</button>
                        <span class="drag-handle">↕</span>
                    </td>
                `;
                tbody.appendChild(tr);
                tr.addEventListener("dragstart", e => {
                    e.dataTransfer.setData("text/plain", index);
                    tr.classList.add("dragging");
                });
                tr.addEventListener("dragend", () => {
                    tr.classList.remove("dragging");
                });
                tr.addEventListener("dragover", e => {
                    e.preventDefault();
                    tr.classList.add("drag-over");
                });
                tr.addEventListener("dragleave", () => {
                    tr.classList.remove("drag-over");
                });
                tr.addEventListener("drop", e => {
                    e.preventDefault();
                    tr.classList.remove("drag-over");
                    const fromIndex = parseInt(e.dataTransfer.getData("text/plain"));
                    const toIndex = index;
                    if (isNaN(fromIndex) || fromIndex === toIndex) return;
                    const moved = cls.assignments.splice(fromIndex, 1)[0];
                    cls.assignments.splice(toIndex, 0, moved);
                    saveData().then(() => {
                        renderAssignments(classIndex);
                        calculateGrade(classIndex);
                    });
                });
            });
            
            assignmentList.appendChild(table);
            
            // Add grade without drops indicator if applicable
            if (gradeDifference !== 0) {
                const gradeInfo = document.createElement('div');
                gradeInfo.className = 'grade-without-drops';
                const diffText = gradeDifference > 0 ? 
                    `Drops improved grade by ${gradeDifference}%` :
                    `Drops lowered grade by ${Math.abs(gradeDifference)}%`;
                    
                gradeInfo.textContent = `Without drops: ${originalGrade}% | ${diffText}`;
                
                // Add to the grade summary section instead of assignment list
                const gradeElement = document.querySelector('#grade-summary');
                if (gradeElement) {
                    gradeElement.appendChild(gradeInfo);
                }
            }
            
            // Add animation to rows for visual appeal
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, i) => {
                row.style.animation = `fadeIn 0.3s ease forwards ${i * 0.05}s`;
                row.style.opacity = '0';
            });
            
            // Add animation keyframes if not already added
            if (!document.getElementById('row-animation-style')) {
                const style = document.createElement('style');
                style.id = 'row-animation-style';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Function to find assignments that would be dropped
        function findAssignmentsToBeDropped(cls) {
            const droppedAssignments = [];
            
            cls.categories.forEach((cat, categoryIndex) => {
                const numToDrop = cat.numToDrop || 0;
                if (numToDrop <= 0) return;
                
                // Get non-excluded assignments in this category
                const assignmentsInCategory = cls.assignments
                    .map((a, i) => ({...a, index: i}))
                    .filter(a => 
                        a.categoryIndex === categoryIndex && 
                        !a.exclude && 
                        a.score !== null && 
                        a.total !== null
                    );
                
                if (assignmentsInCategory.length <= numToDrop) return;
                
                // Sort by percentage (lowest first)
                assignmentsInCategory.sort((a, b) => {
                    const aPerc = a.score / a.total;
                    const bPerc = b.score / b.total;
                    return aPerc - bPerc;
                });
                
                // Get indices of assignments to drop
                const toDrop = assignmentsInCategory.slice(0, numToDrop).map(a => a.index);
                droppedAssignments.push(...toDrop);
            });
            
            return droppedAssignments;
        }
        
        // Calculate grade difference with and without drops
        function calculateGradeDifference(cls, droppedIndices) {
            // First calculate grade WITH drops (normal calculation)
            const withDropsData = calculateGradeData(cls, droppedIndices);
            
            // Then calculate WITHOUT drops
            const withoutDropsData = calculateGradeData(cls, []);
            
            // Return the difference
            return withDropsData.finalGrade - withoutDropsData.finalGrade;
        }
        
        // Calculate grade based on which assignments to drop
        function calculateGradeData(cls, droppedIndices) {
            const dropSet = new Set(droppedIndices);
            const categoryGrades = {};
            
            cls.categories.forEach((cat, index) => {
                categoryGrades[index] = [];
            });
            
            cls.assignments.forEach((assignment, index) => {
                if (
                    !assignment.exclude && 
                    !dropSet.has(index) && 
                    assignment.score !== null && 
                    assignment.total !== null
                ) {
                    categoryGrades[assignment.categoryIndex].push((assignment.score / assignment.total) * 100);
                }
            });
            
            let totalWeightedScore = 0;
            let totalWeights = 0;
            
            cls.categories.forEach((cat, index) => {
                const grades = categoryGrades[index];
                if (grades && grades.length > 0) {
                    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                    totalWeightedScore += (average * cat.weight);
                    totalWeights += cat.weight;
                }
            });
            
            const finalGrade = totalWeights > 0 ? totalWeightedScore / totalWeights : 0;
            
            return {
                finalGrade,
                totalWeightedScore,
                totalWeights
            };
        }



        function editAssignment(classIndex, assignmentIndex) {
            const cls = classes[classIndex];
            const assignment = cls.assignments[assignmentIndex];

            const categoryOptions = cls.categories.map((cat, index) => `<option value="${index}" ${index === assignment.categoryIndex ? 'selected' : ''}>${cat.name}</option>`).join('');

            const assignmentList = document.getElementById('assignment-list');
            const table = assignmentList.querySelector('table');
            const rows = table.querySelectorAll('tbody tr');
            const assignmentRow = rows[assignmentIndex];

            const editRow = document.createElement('tr');
            let scoreText = '';
            if (assignment.score !== null && assignment.total !== null) {
                scoreText = `${assignment.score}/${assignment.total}`;
            }

            editRow.innerHTML = `
                <td colspan="6">
                    <div class="assignment">
                        <label>Assignment Name</label>
                        <input type="text" value="${assignment.name}">
                        <label>Category</label>
                        <select>
                            ${categoryOptions}
                        </select>
                        <label>Score (blank if incomplete)</label>
                        <input type="text" value="${scoreText}">
                        <label style="margin-top:10px;">
                            <input type="checkbox" ${assignment.exclude ? 'checked' : ''}> Exclude from Grade
                        </label>
                        <div style="margin-top:15px;">
                            <button class="button small" onclick="saveEditedAssignment(${classIndex}, ${assignmentIndex}, this)">Save</button>
                            <button class="button accent small" onclick="renderAssignments(${classIndex})">Cancel</button>
                        </div>
                    </div>
                </td>
            `;
            table.querySelector('tbody').replaceChild(editRow, assignmentRow);
        }

        async function saveEditedAssignment(classIndex, assignmentIndex, button) {
            const cls = classes[classIndex];
            const assignment = cls.assignments[assignmentIndex];
            const assignmentDiv = button.parentElement.parentElement;
            const inputs = assignmentDiv.querySelectorAll('input');
            const selects = assignmentDiv.querySelectorAll('select');
            const name = inputs[0].value.trim();
            const categoryIndex = Number(selects[0].value);
            const gradeInput = inputs[1].value.trim();
            const exclude = inputs[2].checked;

            let score = null;
            let total = null;
            if (gradeInput && gradeInput.includes('/')) {
                const parts = gradeInput.split('/');
                score = Number(parts[0]);
                total = Number(parts[1]);
                if (isNaN(score) || isNaN(total) || total === 0) {
                    alert('Invalid score format. Please use format like "18/25".');
                    return;
                }
            }

            if (name === '') {
                alert('Please enter a valid assignment name.');
                return;
            }

            // Track changes for history
            const oldScore = assignment.score;
            const oldTotal = assignment.total;
            const oldCategoryIndex = assignment.categoryIndex;
            
            // Update assignment
            assignment.name = name;
            assignment.categoryIndex = categoryIndex;
            assignment.score = score;
            assignment.total = total;
            assignment.exclude = exclude;
            assignment.dateModified = new Date();
            
            // Record grade snapshot if score changed
            if (oldScore !== score || oldTotal !== total || oldCategoryIndex !== categoryIndex) {
                recordGradeSnapshot("Updated Assignment", {
                    assignmentName: name,
                    oldScore: oldScore,
                    oldTotal: oldTotal,
                    newScore: score,
                    newTotal: total,
                    category: cls.categories[categoryIndex].name
                });
            }
            
            await saveData();
            renderAssignments(classIndex);
            calculateGrade(classIndex);
        }

        async function deleteAssignment(classIndex, assignmentIndex) {
            if (confirm('Are you sure you want to delete this assignment?')) {
                const cls = classes[classIndex];
                
                // Record the deletion for history
                const assignment = cls.assignments[assignmentIndex];
                recordGradeSnapshot("Deleted Assignment", {
                    assignmentName: assignment.name,
                    score: assignment.score,
                    total: assignment.total,
                    category: cls.categories[assignment.categoryIndex].name
                });
                
                // Actually remove the assignment
                cls.assignments.splice(assignmentIndex, 1);
                await saveData();
                
                // Animation for the deleted row
                const table = document.querySelector('#assignment-list table');
                if (table) {
                    const rows = table.querySelectorAll('tbody tr');
                    if (rows[assignmentIndex]) {
                        rows[assignmentIndex].style.animation = 'deleteAnimation 0.5s ease forwards';
                        
                        // Add animation keyframes if not already added
                        if (!document.getElementById('delete-animation-style')) {
                            const style = document.createElement('style');
                            style.id = 'delete-animation-style';
                            style.textContent = `
                                @keyframes deleteAnimation {
                                    0% { transform: translateX(0); opacity: 1; }
                                    100% { transform: translateX(50px); opacity: 0; }
                                }
                            `;
                            document.head.appendChild(style);
                        }
                        
                        // Delay actual re-render to allow animation to complete
                        setTimeout(() => {
                            renderAssignments(classIndex);
                            calculateGrade(classIndex);
                        }, 500);
                    } else {
                        renderAssignments(classIndex);
                        calculateGrade(classIndex);
                    }
                } else {
                    renderAssignments(classIndex);
                    calculateGrade(classIndex);
                }
            }
        }

        /*============================
          GRADE CALCULATION
        ============================*/

        function isAssignmentDropped(cls, categoryIndex, assignmentIndex) {
            const cat = cls.categories[categoryIndex];
            const numToDrop = cat.numToDrop || 0;
            if (numToDrop <= 0) return false;

            const assignmentsInCategory = cls.assignments
                .map((a, i) => ({...a, index: i}))
                .filter(a => 
                    a.categoryIndex === categoryIndex && 
                    !a.exclude && 
                    a.score !== null && 
                    a.total !== null
                );

            // If there are fewer or equal assignments than numToDrop, don't drop any
            if (assignmentsInCategory.length <= numToDrop) return false;

            assignmentsInCategory.sort((a, b) => {
                const aPerc = a.score / a.total;
                const bPerc = b.score / b.total;
                return aPerc - bPerc;
            });

            const droppedAssignments = assignmentsInCategory.slice(0, numToDrop);
            return droppedAssignments.some(a => a.index === assignmentIndex);
        }

        // === Updated GPA scale ===
        // A+: >= 96.5 = 4.33
        // A : >= 92.5 = 4.0
        // A-: >= 89.5 = 3.67
        // B+: >= 86.5 = 3.33
        // B : >= 82.5 = 3.0
        // B-: >= 79.5 = 2.67
        // C+: >= 76.5 = 2.33
        // C : >= 72.5 = 2.0
        // C-: >= 69.5 = 1.67
        // D : >= 64.5 = 1.0
        // F : below 64.5 = 0.0

        function calculateGrade(classIndex) {
            const cls = classes[classIndex];

            const categoryGrades = {};
            cls.categories.forEach((cat, index) => {
                categoryGrades[index] = [];
            });

            cls.assignments.forEach((assignment, index) => {
                if (
                    !assignment.exclude && 
                    !isAssignmentDropped(cls, assignment.categoryIndex, index) && 
                    assignment.score !== null && 
                    assignment.total !== null
                ) {
                    categoryGrades[assignment.categoryIndex].push((assignment.score / assignment.total) * 100);
                }
            });

            let totalWeightedScore = 0;
            let totalWeights = 0;
            let categoryAverages = {};

            cls.categories.forEach((cat, index) => {
                const grades = categoryGrades[index];
                if (grades && grades.length > 0) {
                    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                    totalWeightedScore += (average * cat.weight);
                    totalWeights += cat.weight;
                    categoryAverages[cat.name] = average.toFixed(2) + '%';
                } else {
                    categoryAverages[cat.name] = 'No Assignments';
                }
            });

            // Handle case when totalWeights is 0
            const finalGrade = totalWeights > 0 ? (totalWeightedScore / totalWeights).toFixed(2) : '0.00';
            const letterGrade = getLetterGrade(finalGrade);
            const gpaScale = getGPA(finalGrade).toFixed(2);

            // Determine grade class for coloring
            let gradeClass = '';
            if (finalGrade >= 96.5) gradeClass = 'grade-a-plus';
            else if (finalGrade >= 92.5) gradeClass = 'grade-a';
            else if (finalGrade >= 89.5) gradeClass = 'grade-a-minus';
            else if (finalGrade >= 86.5) gradeClass = 'grade-b-plus';
            else if (finalGrade >= 82.5) gradeClass = 'grade-b';
            else if (finalGrade >= 79.5) gradeClass = 'grade-b-minus';
            else if (finalGrade >= 76.5) gradeClass = 'grade-c-plus';
            else if (finalGrade >= 72.5) gradeClass = 'grade-c';
            else if (finalGrade >= 69.5) gradeClass = 'grade-c-minus';
            else if (finalGrade >= 64.5) gradeClass = 'grade-d';
            else gradeClass = 'grade-f';

            const gradeSummary = document.getElementById('grade-summary');
            let categoryAverageHTML = '<div style="margin-top: 15px;"><h4>Category Averages:</h4><ul style="list-style-type: none; padding-left: 0;">';
            for (const [catName, avg] of Object.entries(categoryAverages)) {
                let avgClass = '';
                if (avg !== 'No Assignments') {
                    const avgNum = parseFloat(avg);
                    if (avgNum >= 96.5) avgClass = 'grade-a-plus';
                    else if (avgNum >= 92.5) avgClass = 'grade-a';
                    else if (avgNum >= 89.5) avgClass = 'grade-a-minus';
                    else if (avgNum >= 86.5) avgClass = 'grade-b-plus';
                    else if (avgNum >= 82.5) avgClass = 'grade-b';
                    else if (avgNum >= 79.5) avgClass = 'grade-b-minus';
                    else if (avgNum >= 76.5) avgClass = 'grade-c-plus';
                    else if (avgNum >= 72.5) avgClass = 'grade-c';
                    else if (avgNum >= 69.5) avgClass = 'grade-c-minus';
                    else if (avgNum >= 64.5) avgClass = 'grade-d';
                    else avgClass = 'grade-f';
                }
                categoryAverageHTML += `<li><strong>${catName}:</strong> <span class="${avgClass}">${avg}</span></li>`;
            }
            categoryAverageHTML += '</ul></div>';

            gradeSummary.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                    <div style="font-size: 18px; margin-bottom: 5px;">Your current grade is:</div>
                    <div class="${gradeClass}" style="font-size: 48px; font-weight: bold; margin-bottom: 10px;">${finalGrade}%</div>
                    <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                        <div style="padding: 8px 15px; background: #1e1e1e; border-radius: 20px;">
                            <strong>Letter Grade:</strong> <span class="${gradeClass}">${letterGrade}</span>
                        </div>
                        <div style="padding: 8px 15px; background: #1e1e1e; border-radius: 20px;">
                            <strong>GPA:</strong> <span class="${gradeClass}">${gpaScale}</span>
                        </div>
                    </div>
                </div>
                ${categoryAverageHTML}
            `;
            
            // Render History Chart
            renderGradeHistory(classIndex);
            
            // Generate and Display Insights
            generateInsights(classIndex);
            
            // Display Personal Bests
            displayPersonalBests(classIndex);
        }
        
        function renderGradeHistory(classIndex) {
            // Check if container exists
            const chartContainer = document.querySelector('.chart-container');
            if (!chartContainer) return;
            
            // Make sure we have a class
            const cls = classes[classIndex];
            if (!cls) {
                chartContainer.innerHTML = '<p>Class data not found.</p>';
                return;
            }
            
            // Get history data specifically for this class
            let relevantHistory = [];
            if (gradeHistory && gradeHistory.length > 0) {
                relevantHistory = gradeHistory.filter(entry => 
                    entry.classId === classIndex && 
                    entry.grade !== undefined && 
                    !isNaN(entry.grade)
                );
            }
            
            // Handle no data case
            if (relevantHistory.length === 0) {
                chartContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">📊</div>
                        <p>No grade history data available yet.</p>
                        <p>Add or update assignments to track your grade progress over time.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by timestamp
            relevantHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Clean up the data - remove consecutive duplicates
            const cleanHistory = [];
            for (let i = 0; i < relevantHistory.length; i++) {
                // Skip entries that have the same grade as the previous entry
                if (i > 0 && 
                    Math.abs(relevantHistory[i].grade - relevantHistory[i-1].grade) < 0.001 &&
                    relevantHistory[i].eventType === relevantHistory[i-1].eventType) {
                    continue;
                }
                cleanHistory.push(relevantHistory[i]);
            }
            
            // ==== Render chart using Chart.js ====
            const currentGrade = cleanHistory[cleanHistory.length - 1].grade;

            // Reset container to only the canvas
            chartContainer.innerHTML = '<canvas id="gradeHistoryChart"></canvas>';
            const ctx = document.getElementById('gradeHistoryChart').getContext('2d');

            const points = cleanHistory.map(e => ({
                x: parseTimestamp(e.timestamp),
                y: e.grade
            }));

            const grades = points.map(p => p.y);
            const minGrade = Math.min(...grades);
            const maxGrade = Math.max(...grades);
            const yMin = Math.max(0, Math.floor(minGrade - 5));
            const yMax = Math.min(100, Math.ceil(maxGrade + 5));

            if (gradeChart) {
                gradeChart.destroy();
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
            gradient.addColorStop(0, 'rgba(66,133,244,0.4)');
            gradient.addColorStop(1, 'rgba(66,133,244,0)');

            gradeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Grade %',
                        data: points,
                        parsing: false,
                        borderColor: 'var(--accent-color)',
                        borderWidth: 2,
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.3,
                        cubicInterpolationMode: 'monotone',
                        pointRadius: ctx => ctx.dataIndex === points.length - 1 ? 6 : 4,
                        pointHoverRadius: 6,
                        spanGaps: true

                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500,
                        easing: 'easeOutQuart'
                    },
                    layout: {
                        padding: { top: 10, right: 15, left: 10, bottom: 0 }
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    },
                    scales: {
                        y: {
                            min: yMin,
                            max: yMax,

                            grid: {
                                color: '#333'
                            },

                            title: {
                                display: true,
                                text: 'Grade %'
                            }
                        },
                        x: {
                            type: 'time',

                            offset: true,
                            grid: {
                                color: '#333'
                            },

                            time: {
                                tooltipFormat: 'PPpp'
                            },
                            title: {
                                display: true,
                                text: 'Date'

                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(50,50,50,0.9)',
                            callbacks: {
                                title: function(context) {
                                    const ts = context[0].parsed.x;
                                    return ts ? new Date(ts).toLocaleString() : '';
                                },
                                label: function(context) {
                                    const entry = cleanHistory[context.dataIndex];
                                    let label = `${entry.grade.toFixed(2)}%`;
                                    if (entry.details && entry.details.assignmentName) {
                                        label += ` - ${entry.details.assignmentName}`;
                                    }
                                    if (entry.eventType) {
                                        label += ` (${entry.eventType})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            const header = document.createElement('div');
            header.style.marginTop = '10px';
            header.style.textAlign = 'center';
            header.innerHTML = `<strong>Current Grade:</strong> <span style="color: var(--accent-color);">${currentGrade.toFixed(2)}%</span>`;
            chartContainer.prepend(header);
        }
        
        function generateInsights(classIndex) {
            const cls = classes[classIndex];
            const insightsContainer = document.getElementById('grade-insights');
            
            // Empty container
            insightsContainer.innerHTML = '';
            
            if (!cls.assignments || cls.assignments.length < 3) {
                insightsContainer.innerHTML = '<p>Add more assignments to get personalized insights about your performance.</p>';
                return;
            }
            
            // Create a collection of insights
            const insights = [];
            
            // Get assignments with grades
            const gradedAssignments = cls.assignments.filter(a => 
                !a.exclude && a.score !== null && a.total !== null);
            
            if (gradedAssignments.length < 3) {
                insightsContainer.innerHTML = '<p>Add more graded assignments to get personalized insights about your performance.</p>';
                return;
            }
            
            // Calculate grade percentages for each assignment
            const assignmentPercentages = gradedAssignments.map(a => {
                return {
                    name: a.name,
                    percentage: (a.score / a.total) * 100,
                    categoryIndex: a.categoryIndex,
                };
            });
            
            // === INSIGHT: Recent Performance Trend ===
            if (assignmentPercentages.length >= 3) {
                const last3 = assignmentPercentages.slice(-3);
                const last3Avg = last3.reduce((sum, a) => sum + a.percentage, 0) / 3;
                
                // Compare with previous
                if (assignmentPercentages.length > 5) {
                    const previous3 = assignmentPercentages.slice(-6, -3);
                    const previous3Avg = previous3.reduce((sum, a) => sum + a.percentage, 0) / 3;
                    const difference = last3Avg - previous3Avg;
                    
                    if (Math.abs(difference) >= 5) {
                        if (difference > 0) {
                            insights.push({
                                title: 'Improvement Trend',
                                content: `Your recent 3 assignments (${last3Avg.toFixed(1)}%) show a ${difference.toFixed(1)}% improvement compared to the previous 3 (${previous3Avg.toFixed(1)}%).`,
                                type: 'positive'
                            });
                        } else {
                            insights.push({
                                title: 'Performance Dip',
                                content: `Your recent 3 assignments (${last3Avg.toFixed(1)}%) are ${Math.abs(difference).toFixed(1)}% lower than your previous 3 (${previous3Avg.toFixed(1)}%). Consider reviewing your study habits.`,
                                type: 'negative'
                            });
                        }
                    } else {
                        insights.push({
                            title: 'Consistent Performance',
                            content: `Your performance has been stable, with your recent 3 assignments (${last3Avg.toFixed(1)}%) close to your previous 3 (${previous3Avg.toFixed(1)}%).`,
                            type: 'neutral'
                        });
                    }
                }
            }
            
            // === INSIGHT: Category Strengths and Weaknesses ===
            const categoryPerformance = {};
            cls.categories.forEach((cat, index) => {
                const assignmentsInCategory = assignmentPercentages.filter(a => a.categoryIndex === index);
                if (assignmentsInCategory.length > 0) {
                    const avg = assignmentsInCategory.reduce((sum, a) => sum + a.percentage, 0) / assignmentsInCategory.length;
                    categoryPerformance[index] = {
                        name: cat.name,
                        average: avg
                    };
                }
            });
            
            // Find best and worst categories
            const categoryIndices = Object.keys(categoryPerformance);
            if (categoryIndices.length >= 2) {
                // Sort by average
                const sortedCategories = [...categoryIndices].sort((a, b) => 
                    categoryPerformance[b].average - categoryPerformance[a].average);
                
                const bestCat = categoryPerformance[sortedCategories[0]];
                const worstCat = categoryPerformance[sortedCategories[sortedCategories.length - 1]];
                
                if (bestCat.average - worstCat.average >= 10) {
                    insights.push({
                        title: 'Category Strength',
                        content: `You're performing best in "${bestCat.name}" (${bestCat.average.toFixed(1)}%) and have room for improvement in "${worstCat.name}" (${worstCat.average.toFixed(1)}%).`,
                        type: 'neutral'
                    });
                }
            }
            
            // === INSIGHT: Achievement Streaks ===
            let currentStreak = 0;
            let streakThreshold = 85; // Count as part of streak if >=85%
            
            for (let i = 0; i < assignmentPercentages.length; i++) {
                if (assignmentPercentages[i].percentage >= streakThreshold) {
                    currentStreak++;
                } else {
                    // Reset streak
                    currentStreak = 0;
                }
            }
            
            if (currentStreak >= 3) {
                insights.push({
                    title: 'Current Streak',
                    content: `You're on a ${currentStreak}-assignment streak of scores above ${streakThreshold}%! Keep up the great work!`,
                    type: 'positive'
                });
            }
            
            // === INSIGHT: Most Improved Category ===
            if (assignmentPercentages.length >= 6) {
                // Check for category improvement
                const categoryImprovement = {};
                
                cls.categories.forEach((cat, index) => {
                    const assignmentsInCategory = assignmentPercentages.filter(a => a.categoryIndex === index);
                    
                    if (assignmentsInCategory.length >= 3) {
                        // Split into halves
                        const halfway = Math.floor(assignmentsInCategory.length / 2);
                        const firstHalf = assignmentsInCategory.slice(0, halfway);
                        const secondHalf = assignmentsInCategory.slice(halfway);
                        
                        const firstHalfAvg = firstHalf.reduce((sum, a) => sum + a.percentage, 0) / firstHalf.length;
                        const secondHalfAvg = secondHalf.reduce((sum, a) => sum + a.percentage, 0) / secondHalf.length;
                        
                        categoryImprovement[index] = {
                            name: cat.name,
                            improvement: secondHalfAvg - firstHalfAvg
                        };
                    }
                });
                
                const improvementIndices = Object.keys(categoryImprovement);
                if (improvementIndices.length > 0) {
                    // Sort by improvement
                    const sortedImprovement = [...improvementIndices].sort((a, b) => 
                        categoryImprovement[b].improvement - categoryImprovement[a].improvement);
                    
                    const mostImproved = categoryImprovement[sortedImprovement[0]];
                    
                    if (mostImproved.improvement > 5) {
                        insights.push({
                            title: 'Most Improved',
                            content: `You've shown the most improvement in "${mostImproved.name}" with a ${mostImproved.improvement.toFixed(1)}% increase over time!`,
                            type: 'positive'
                        });
                    } else if (mostImproved.improvement < -5) {
                        insights.push({
                            title: 'Performance Drop',
                            content: `Your scores in "${mostImproved.name}" have dropped by ${Math.abs(mostImproved.improvement).toFixed(1)}% over time. Consider refocusing your study efforts.`,
                            type: 'negative'
                        });
                    }
                }
            }
            
            // === INSIGHT: Grade Distribution ===
            const gradeDistribution = {
                A: 0, // 90-100
                B: 0, // 80-89.9
                C: 0, // 70-79.9
                D: 0, // 65-69.9
                F: 0  // <65
            };
            
            assignmentPercentages.forEach(a => {
                if (a.percentage >= 90) gradeDistribution.A++;
                else if (a.percentage >= 80) gradeDistribution.B++;
                else if (a.percentage >= 70) gradeDistribution.C++;
                else if (a.percentage >= 65) gradeDistribution.D++;
                else gradeDistribution.F++;
            });
            
            // Find the most common grade
            const sortedGrades = Object.keys(gradeDistribution).sort((a, b) => 
                gradeDistribution[b] - gradeDistribution[a]);
            
            const mostCommonGrade = sortedGrades[0];
            const mostCommonCount = gradeDistribution[mostCommonGrade];
            
            if (mostCommonCount >= 3 && mostCommonCount / assignmentPercentages.length >= 0.4) {
                if (mostCommonGrade === 'A') {
                    insights.push({
                        title: 'Grade Distribution',
                        content: `The majority of your assignments (${mostCommonCount} out of ${assignmentPercentages.length}) earned A grades. Excellent consistency!`,
                        type: 'positive'
                    });
                } else if (mostCommonGrade === 'B') {
                    insights.push({
                        title: 'Grade Distribution',
                        content: `Most of your assignments (${mostCommonCount} out of ${assignmentPercentages.length}) earned B grades. Strong performance!`,
                        type: 'positive'
                    });
                } else if (mostCommonGrade === 'C') {
                    insights.push({
                        title: 'Grade Distribution',
                        content: `Most of your assignments (${mostCommonCount} out of ${assignmentPercentages.length}) earned C grades. Consider targeted studying to improve.`,
                        type: 'neutral'
                    });
                } else {
                    insights.push({
                        title: 'Grade Distribution',
                        content: `Most of your assignments (${mostCommonCount} out of ${assignmentPercentages.length}) earned ${mostCommonGrade} grades. Consider getting additional help to improve your scores.`,
                        type: 'negative'
                    });
                }
            }
            
            // Add more insights here...
            
            // Display insights
            if (insights.length === 0) {
                insightsContainer.innerHTML = '<p>Add more varied assignments to get personalized insights about your performance.</p>';
                return;
            }
            
            // Limit to 3 most relevant insights
            const displayInsights = insights.slice(0, 3);
            
            displayInsights.forEach(insight => {
                let borderColor = 'var(--accent-color)';
                if (insight.type === 'positive') borderColor = 'var(--success-color)';
                if (insight.type === 'negative') borderColor = 'var(--error-color)';
                
                const insightCard = document.createElement('div');
                insightCard.className = 'insight-card';
                insightCard.style.borderLeftColor = borderColor;
                
                insightCard.innerHTML = `
                    <div class="insight-title">${insight.title}</div>
                    <p style="margin: 5px 0;">${insight.content}</p>
                `;
                
                insightsContainer.appendChild(insightCard);
            });
        }
        
        function displayPersonalBests(classIndex) {
            const personalBestsContainer = document.getElementById('personal-bests');
            personalBestsContainer.innerHTML = '';
            
            // Filter for this class
            const classBests = personalBests.filter(pb => pb.classId === classIndex);
            
            if (classBests.length === 0) {
                personalBestsContainer.innerHTML = '<p>Complete more assignments to unlock your personal bests!</p>';
                return;
            }
            
            // Display top 3 personal bests
            const displayBests = classBests.slice(0, 3);
            
            displayBests.forEach(best => {
                const bestCard = document.createElement('div');
                bestCard.className = 'personal-best';
                
                bestCard.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${best.description}</div>
                    <div>${best.value.toFixed(1)}%</div>
                `;
                
                personalBestsContainer.appendChild(bestCard);
            });
        }

        function getLetterGrade(percentage) {
            percentage = Number(percentage);
            if (percentage >= 96.5) return 'A+';
            if (percentage >= 92.5) return 'A';
            if (percentage >= 89.5) return 'A-';
            if (percentage >= 86.5) return 'B+';
            if (percentage >= 82.5) return 'B';
            if (percentage >= 79.5) return 'B-';
            if (percentage >= 76.5) return 'C+';
            if (percentage >= 72.5) return 'C';
            if (percentage >= 69.5) return 'C-';
            if (percentage >= 64.5) return 'D';
            return 'F';
        }

        function getGPA(percentage) {
            percentage = Number(percentage);
            if (percentage >= 96.5) return 4.33;
            if (percentage >= 92.5) return 4.0;
            if (percentage >= 89.5) return 3.67;
            if (percentage >= 86.5) return 3.33;
            if (percentage >= 82.5) return 3.0;
            if (percentage >= 79.5) return 2.67;
            if (percentage >= 76.5) return 2.33;
            if (percentage >= 72.5) return 2.0;
            if (percentage >= 69.5) return 1.67;
            if (percentage >= 64.5) return 1.0;
            return 0.0;
        }

        function getPercentageFromGPA(gpa) {
            gpa = Number(gpa);
            if (isNaN(gpa)) return 0;

            // Approximate midpoints for display
            // Using the updated 4.33 scale
            
            // Handle exact matches
            if (gpa === 4.33) return 98;    // A+
            if (gpa === 4.0) return 94;     // A
            if (gpa === 3.67) return 91;    // A-
            if (gpa === 3.33) return 88;    // B+
            if (gpa === 3.0) return 85;     // B
            if (gpa === 2.67) return 81;    // B-
            if (gpa === 2.33) return 78;    // C+
            if (gpa === 2.0) return 75;     // C
            if (gpa === 1.67) return 71;    // C-
            if (gpa === 1.0) return 67;     // D
            if (gpa === 0.0) return 60;     // F
            
            // Handle intermediate values
            if (gpa > 4.0) return 94 + (gpa - 4.0) * (98 - 94) / (4.33 - 4.0);
            if (gpa > 3.67) return 91 + (gpa - 3.67) * (94 - 91) / (4.0 - 3.67);
            if (gpa > 3.33) return 88 + (gpa - 3.33) * (91 - 88) / (3.67 - 3.33);
            if (gpa > 3.0) return 85 + (gpa - 3.0) * (88 - 85) / (3.33 - 3.0);
            if (gpa > 2.67) return 81 + (gpa - 2.67) * (85 - 81) / (3.0 - 2.67);
            if (gpa > 2.33) return 78 + (gpa - 2.33) * (81 - 78) / (2.67 - 2.33);
            if (gpa > 2.0) return 75 + (gpa - 2.0) * (78 - 75) / (2.33 - 2.0);
            if (gpa > 1.67) return 71 + (gpa - 1.67) * (75 - 71) / (2.0 - 1.67);
            if (gpa > 1.0) return 67 + (gpa - 1.0) * (71 - 67) / (1.67 - 1.0);
            
            // If GPA is between 0 and 1.0
            if (gpa > 0) return 60 + gpa * (67 - 60) / 1.0;
            
            return 60; // Default for F
        }

        function getLetterGradeFromGPA(gpa) {
            gpa = Number(gpa);
            
            // Handle ranges instead of exact values
            if (gpa >= 4.33) return 'A+';
            if (gpa >= 4.0) return 'A';
            if (gpa >= 3.67) return 'A-';
            if (gpa >= 3.33) return 'B+';
            if (gpa >= 3.0) return 'B';
            if (gpa >= 2.67) return 'B-';
            if (gpa >= 2.33) return 'C+';
            if (gpa >= 2.0) return 'C';
            if (gpa >= 1.67) return 'C-';
            if (gpa >= 1.0) return 'D';
            return 'F';
        }

        /*============================
          EXPORT / IMPORT
        ============================*/
        document.getElementById('export-data-btn').onclick = function() {
            const data = {
                classes: classes,
                semesters: semesters
            };
            const dataStr = JSON.stringify(data);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = 'grade_tracker_data.json';

            let linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        document.getElementById('export-csv-btn').onclick = function() {
            // Simple CSV export of classes and assignments
            let csv = "Class,Category,Assignment,Score,Total,Excluded\n";
            classes.forEach(cls => {
                cls.assignments.forEach(a => {
                    const catName = cls.categories[a.categoryIndex] ? cls.categories[a.categoryIndex].name : '';
                    csv += `"${cls.name}","${catName}","${a.name}",${a.score !== null ? a.score : ''},${a.total !== null ? a.total : ''},${a.exclude}\n`;
                });
            });

            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'grade_tracker_data.csv');
            link.click();
        };

        document.getElementById('import-data-btn').onclick = function() {
            document.getElementById('import-file-input').click();
        };

        document.getElementById('import-file-input').onchange = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;
                    let importedData;
                    if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(text);
                    } else if (file.name.endsWith('.csv')) {
                        // CSV import: Just as a naive example
                        const lines = text.split('\n').filter(l=>l.trim()!=='');
                        // first line is header
                        const classMap = {};

                        lines.slice(1).forEach(line=>{
                            const [clsName, catName, aName, score, total, exclude] = line.split(',');
                            const cName = clsName.replace(/"/g,'');
                            if(!classMap[cName]) {
                                classMap[cName] = {
                                    name: cName,
                                    credits: 1,
                                    categories: [],
                                    assignments: [],
                                    finalCategoryIndex: null
                                };
                            }
                            let catIndex = -1;
                            const realCatName = catName.replace(/"/g,'');
                            if (realCatName) {
                                catIndex = classMap[cName].categories.findIndex(c => c.name === realCatName);
                                if (catIndex === -1) {
                                    classMap[cName].categories.push({name: realCatName, weight:0, numToDrop:0});
                                    catIndex = classMap[cName].categories.length - 1;
                                }
                            } else {
                                // If no category given
                                catIndex = 0;
                                if (classMap[cName].categories.length === 0) {
                                    classMap[cName].categories.push({name: "Uncategorized", weight:0, numToDrop:0});
                                }
                            }
                            classMap[cName].assignments.push({
                                name: aName.replace(/"/g,''),
                                categoryIndex: catIndex,
                                score: score===''?null:Number(score),
                                total: total===''?null:Number(total),
                                exclude: exclude==='true'
                            });
                        });

                        importedData = {
                            classes: Object.values(classMap),
                            semesters: []
                        };
                    } else {
                        throw new Error('Unsupported file format.');
                    }

                    if (importedData.classes && importedData.semesters) {
                        classes = importedData.classes;
                        semesters = importedData.semesters;
                        await saveData();
                        renderClassList();
                        if (classes.length > 0) {
                            renderClassContent(0);
                        } else {
                            document.getElementById('content').innerHTML = '<h2>No classes found</h2><p>Import file contained no classes. Please add a class or import a different file.</p>';
                        }
                        alert('Data imported successfully.');
                    } else {
                        throw new Error('Invalid data format.');
                    }
                } catch (error) {
                    console.error("Import error:", error);
                    alert('Failed to import data: ' + error.message);
                }
            };
            reader.readAsText(file);
        };

        /*============================
          GPA CALCULATOR
        ============================*/

        function renderGPACalculator() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>GPA Calculator</h2>
                <section id="gpa-calculator-section">
                    <div id="semester-list"></div>
                    <button class="button" onclick="addSemester()">Add Semester</button>
                    <label style="display: block; margin-top: 15px;">
                        <input type="checkbox" id="include-current-semester" onchange="calculateCumulativeGPA()"> Include Current Semester in Cumulative GPA
                    </label>
                </section>
                <section id="cumulative-gpa-summary"></section>
                <section>
                    <h3>Course Comparison</h3>
                    <p>Compare your performance across different courses to identify strengths and areas for improvement.</p>
                    <div id="course-comparison" class="course-comparison"></div>
                </section>
            `;
            
            // Remove active class from sidebar
            document.querySelectorAll('#class-list li').forEach(el => el.classList.remove('active'));

            // Populate existing data
            renderSemesters();
            calculateCumulativeGPA();
        }


        function addSemester() {
            const semesterDiv = document.createElement('div');
            semesterDiv.className = 'semester';
            semesterDiv.style.backgroundColor = '#222';
            semesterDiv.style.padding = '15px';
            semesterDiv.style.borderRadius = '8px';
            semesterDiv.style.marginBottom = '15px';
            
            semesterDiv.innerHTML = `
                <label>Semester Name</label>
                <input type="text" placeholder="e.g., Fall 2023">
                <div style="margin-top:15px;">
                    <button class="button small" onclick="saveSemester(this)">Save</button>
                    <button class="button accent small" onclick="this.parentElement.parentElement.remove()">Cancel</button>
                </div>
            `;
            document.getElementById('semester-list').appendChild(semesterDiv);
        }

        async function saveSemester(button) {
            const semesterDiv = button.parentElement.parentElement;
            const input = semesterDiv.querySelector('input');
            const name = input.value.trim();
            if (name === '') {
                alert('Please enter a valid semester name.');
                return;
            }

            semesters.push({
                name: name,
                classes: []
            });
            await saveData();
            renderSemesters();
            calculateCumulativeGPA();
        }

        function renderSemesters() {
            const semesterList = document.getElementById('semester-list');
            semesterList.innerHTML = '';
            
            if (semesters.length === 0) {
                semesterList.innerHTML = '<p>No semesters added yet. Add a semester to track your GPA across terms.</p>';
            }
            
            semesters.forEach((semester, sIndex) => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'semester';
                semesterDiv.style.backgroundColor = '#1e1e1e';
                semesterDiv.style.padding = '15px';
                semesterDiv.style.borderRadius = '8px';
                semesterDiv.style.marginBottom = '25px';
                semesterDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
                
                semesterDiv.innerHTML = `
                    <h3>${semester.name}</h3>
                    <div id="class-list-${sIndex}"></div>
                    <div style="margin-top:15px;">
                        <button class="button small" onclick="addClassToSemester(${sIndex})">Add Class</button>
                        <button class="button accent small" onclick="deleteSemester(${sIndex})">Delete Semester</button>
                    </div>
                    <hr style="margin: 15px 0; border-color: #333;">
                `;
                semesterList.appendChild(semesterDiv);
                renderClassesInSemester(sIndex);
            });
        }

        function addClassToSemester(sIndex) {
            const classDiv = document.createElement('div');
            classDiv.className = 'class';
            classDiv.style.backgroundColor = '#222';
            classDiv.style.padding = '15px';
            classDiv.style.borderRadius = '8px';
            classDiv.style.marginBottom = '15px';
            
            classDiv.innerHTML = `
                <label>Class Name</label>
                <input type="text" placeholder="e.g., Chemistry">
                <label>Credits (default is 1)</label>
                <input type="number" placeholder="e.g., 1" min="0.1" step="0.1">
                <label>Letter Grade</label>
                <select>
                    <option value="4.33">A+</option>
                    <option value="4.0">A</option>
                    <option value="3.67">A-</option>
                    <option value="3.33">B+</option>
                    <option value="3.0">B</option>
                    <option value="2.67">B-</option>
                    <option value="2.33">C+</option>
                    <option value="2.0">C</option>
                    <option value="1.67">C-</option>
                    <option value="1.0">D</option>
                    <option value="0.0">F</option>
                </select>
                <div style="margin-top:15px;">
                    <button class="button small" onclick="saveClassInSemester(${sIndex}, this)">Save</button>
                    <button class="button accent small" onclick="this.parentElement.parentElement.remove()">Cancel</button>
                </div>
            `;
            document.getElementById(`class-list-${sIndex}`).appendChild(classDiv);
        }

        async function saveClassInSemester(sIndex, button) {
            const semester = semesters[sIndex];
            const classDiv = button.parentElement.parentElement;
            const inputs = classDiv.querySelectorAll('input');
            const selects = classDiv.querySelectorAll('select');
            const name = inputs[0].value.trim();
            let credits = parseFloat(inputs[1].value);
            const gpa = Number(selects[0].value);
            const letterGrade = getLetterGradeFromGPA(gpa);

            if (name === '') {
                alert('Please enter a valid class name.');
                return;
            }
            if (isNaN(credits) || credits <= 0) {
                credits = 1;
            }

            semester.classes.push({
                name: name,
                credits: credits,
                gpa: gpa.toFixed(2),
                letterGrade: letterGrade
            });
            await saveData();
            renderClassesInSemester(sIndex);
            calculateCumulativeGPA();
        }

        function renderClassesInSemester(sIndex) {
            const semester = semesters[sIndex];
            const classListDiv = document.getElementById(`class-list-${sIndex}`);
            classListDiv.innerHTML = '';
            
            if (!semester.classes || semester.classes.length === 0) {
                classListDiv.innerHTML = '<p>No classes added yet.</p>';
                return;
            }
            
            semester.classes.forEach((cls, cIndex) => {
                const div = document.createElement('div');
                div.className = 'class';
                div.style.margin = '10px 0';
                div.style.padding = '10px';
                div.style.backgroundColor = '#2a2a2a';
                div.style.borderRadius = '5px';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                
                // Determine grade class for coloring
                let gradeClass = '';
                const gpaNum = parseFloat(cls.gpa);
                if (gpaNum === 4.33) gradeClass = 'grade-a-plus';
                else if (gpaNum === 4.0) gradeClass = 'grade-a';
                else if (gpaNum === 3.67) gradeClass = 'grade-a-minus';
                else if (gpaNum === 3.33) gradeClass = 'grade-b-plus';
                else if (gpaNum === 3.0) gradeClass = 'grade-b';
                else if (gpaNum === 2.67) gradeClass = 'grade-b-minus';
                else if (gpaNum === 2.33) gradeClass = 'grade-c-plus';
                else if (gpaNum === 2.0) gradeClass = 'grade-c';
                else if (gpaNum === 1.67) gradeClass = 'grade-c-minus';
                else if (gpaNum === 1.0) gradeClass = 'grade-d';
                else gradeClass = 'grade-f';
                
                div.innerHTML = `
                    <div>
                        <strong>${cls.name}</strong> - 
                        <span class="${gradeClass}">${cls.letterGrade}</span> 
                        (GPA: ${cls.gpa}, Credits: ${cls.credits})
                    </div>
                    <div>
                        <button class="button small" onclick="editClassInSemester(${sIndex}, ${cIndex})">Edit</button>
                        <button class="button accent small" onclick="deleteClassInSemester(${sIndex}, ${cIndex})">Delete</button>
                    </div>
                `;
                classListDiv.appendChild(div);
            });
        }

        function editClassInSemester(sIndex, cIndex) {
            const semester = semesters[sIndex];
            const cls = semester.classes[cIndex];

            const classDiv = document.createElement('div');
            classDiv.className = 'class';
            classDiv.style.backgroundColor = '#222';
            classDiv.style.padding = '15px';
            classDiv.style.borderRadius = '8px';
            classDiv.style.marginBottom = '15px';
            
            classDiv.innerHTML = `
                <label>Class Name</label>
                <input type="text" value="${cls.name}">
                <label>Credits (default is 1)</label>
                <input type="number" value="${cls.credits}" min="0.1" step="0.1">
                <label>Letter Grade</label>
                <select>
                    <option value="4.33" ${cls.gpa === '4.33' ? 'selected' : ''}>A+</option>
                    <option value="4.0"  ${cls.gpa === '4.00' ? 'selected' : ''}>A</option>
                    <option value="3.67" ${cls.gpa === '3.67' ? 'selected' : ''}>A-</option>
                    <option value="3.33" ${cls.gpa === '3.33' ? 'selected' : ''}>B+</option>
                    <option value="3.0"  ${cls.gpa === '3.00' ? 'selected' : ''}>B</option>
                    <option value="2.67" ${cls.gpa === '2.67' ? 'selected' : ''}>B-</option>
                    <option value="2.33" ${cls.gpa === '2.33' ? 'selected' : ''}>C+</option>
                    <option value="2.0"  ${cls.gpa === '2.00' ? 'selected' : ''}>C</option>
                    <option value="1.67" ${cls.gpa === '1.67' ? 'selected' : ''}>C-</option>
                    <option value="1.0"  ${cls.gpa === '1.00' ? 'selected' : ''}>D</option>
                    <option value="0.0"  ${cls.gpa === '0.00' ? 'selected' : ''}>F</option>
                </select>
                <div style="margin-top:15px;">
                    <button class="button small" onclick="saveEditedClassInSemester(${sIndex}, ${cIndex}, this)">Save</button>
                    <button class="button accent small" onclick="renderClassesInSemester(${sIndex})">Cancel</button>
                </div>
            `;

            const classListDiv = document.getElementById(`class-list-${sIndex}`);
            classListDiv.replaceChild(classDiv, classListDiv.children[cIndex]);
        }

        async function saveEditedClassInSemester(sIndex, cIndex, button) {
            const semester = semesters[sIndex];
            const cls = semester.classes[cIndex];
            const classDiv = button.parentElement.parentElement;
            const inputs = classDiv.querySelectorAll('input');
            const selects = classDiv.querySelectorAll('select');
            const name = inputs[0].value.trim();
            let credits = parseFloat(inputs[1].value);
            const gpa = Number(selects[0].value);
            const letterGrade = getLetterGradeFromGPA(gpa);

            if (name === '') {
                alert('Please enter a valid class name.');
                return;
            }
            if (isNaN(credits) || credits <= 0) {
                credits = 1;
            }

            cls.name = name;
            cls.credits = credits;
            cls.gpa = gpa.toFixed(2);
            cls.letterGrade = letterGrade;
            await saveData();
            renderClassesInSemester(sIndex);
            calculateCumulativeGPA();
        }

        async function deleteClassInSemester(sIndex, cIndex) {
            if (confirm('Are you sure you want to delete this class?')) {
                const semester = semesters[sIndex];
                semester.classes.splice(cIndex, 1);
                await saveData();
                renderClassesInSemester(sIndex);
                calculateCumulativeGPA();
            }
        }

        async function deleteSemester(sIndex) {
            if (confirm('Are you sure you want to delete this semester?')) {
                semesters.splice(sIndex, 1);
                await saveData();
                renderSemesters();
                calculateCumulativeGPA();
            }
        }

        function calculateCumulativeGPA() {
            let totalQualityPoints = 0;
            let totalCredits = 0;
            let totalPercentagePoints = 0;
            const cumulativeGPADiv = document.getElementById('cumulative-gpa-summary');
            const courseComparisonDiv = document.getElementById('course-comparison');
            cumulativeGPADiv.innerHTML = '';
            courseComparisonDiv.innerHTML = '';
            
            // Arrays to store all class data for course comparison
            let allClasses = [];

            const includeCurrentSemester = document.getElementById('include-current-semester') ? document.getElementById('include-current-semester').checked : true;

            // Past Semesters
            semesters.forEach(semester => {
                let semesterQualityPoints = 0;
                let semesterCredits = 0;
                let semesterPercentagePoints = 0;
                semester.classes.forEach(cls => {
                    const numericGPA = Number(cls.gpa);
                    semesterQualityPoints += numericGPA * cls.credits;
                    semesterCredits += cls.credits;
                    const percentage = getPercentageFromGPA(numericGPA);
                    semesterPercentagePoints += percentage * cls.credits;
                    
                    // Add to allClasses for comparison
                    allClasses.push({
                        name: cls.name,
                        semester: semester.name,
                        gpa: numericGPA,
                        percentage: percentage,
                        credits: cls.credits,
                        letterGrade: cls.letterGrade
                    });
                });

                totalQualityPoints += semesterQualityPoints;
                totalCredits += semesterCredits;
                totalPercentagePoints += semesterPercentagePoints;

                const averageSemesterGPA = semesterCredits > 0 ? (semesterQualityPoints / semesterCredits).toFixed(2) : 'N/A';
                const averageSemesterPercentage = semesterCredits > 0 ? (semesterPercentagePoints / semesterCredits).toFixed(2) : 'N/A';
                
                // Determine grade class for coloring
                let gradeClass = '';
                if (averageSemesterGPA >= 4.33) gradeClass = 'grade-a-plus';
                else if (averageSemesterGPA >= 4.0) gradeClass = 'grade-a';
                else if (averageSemesterGPA >= 3.67) gradeClass = 'grade-a-minus';
                else if (averageSemesterGPA >= 3.33) gradeClass = 'grade-b-plus';
                else if (averageSemesterGPA >= 3.0) gradeClass = 'grade-b';
                else if (averageSemesterGPA >= 2.67) gradeClass = 'grade-b-minus';
                else if (averageSemesterGPA >= 2.33) gradeClass = 'grade-c-plus';
                else if (averageSemesterGPA >= 2.0) gradeClass = 'grade-c';
                else if (averageSemesterGPA >= 1.67) gradeClass = 'grade-c-minus';
                else if (averageSemesterGPA >= 1.0) gradeClass = 'grade-d';
                else gradeClass = 'grade-f';

                cumulativeGPADiv.innerHTML += `
                    <div style="margin-bottom: 10px; padding: 10px; background: #1e1e1e; border-radius: 6px;">
                        <strong>${semester.name} GPA:</strong> 
                        <span class="${gradeClass}">${averageSemesterGPA}</span>, 
                        Percentage: ${averageSemesterPercentage}%
                    </div>
                `;
            });

            // Current Semester
            if (includeCurrentSemester) {
                let currentSemesterQualityPoints = 0;
                let currentSemesterCredits = 0;
                let currentSemesterPercentagePoints = 0;

                classes.forEach(cls => {
                    let totalWeightedScore = 0;
                    let totalWeights = 0;

                    cls.categories.forEach((cat, index) => {
                        const grades = cls.assignments
                            .filter(a => 
                                a.categoryIndex === index && 
                                !a.exclude && 
                                !isAssignmentDropped(cls, index, cls.assignments.indexOf(a)) && 
                                a.score !== null && 
                                a.total !== null
                            )
                            .map(a => (a.score / a.total) * 100);

                        if (grades.length > 0) {
                            const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                            totalWeightedScore += (average * cat.weight);
                            totalWeights += cat.weight;
                        }
                    });

                    const finalGrade = totalWeights > 0 ? (totalWeightedScore / totalWeights) : 0;
                    const gpa = getGPA(finalGrade);
                    currentSemesterQualityPoints += gpa * cls.credits;
                    currentSemesterCredits += cls.credits;
                    currentSemesterPercentagePoints += finalGrade * cls.credits;
                });

                if (currentSemesterCredits > 0) {
                    const averageCurrentGPA = (currentSemesterQualityPoints / currentSemesterCredits).toFixed(2);
                    const averageCurrentPercentage = (currentSemesterPercentagePoints / currentSemesterCredits).toFixed(2);
                    
                    // Determine grade class for coloring
                    let gradeClass = '';
                    if (averageCurrentGPA >= 4.33) gradeClass = 'grade-a-plus';
                    else if (averageCurrentGPA >= 4.0) gradeClass = 'grade-a';
                    else if (averageCurrentGPA >= 3.67) gradeClass = 'grade-a-minus';
                    else if (averageCurrentGPA >= 3.33) gradeClass = 'grade-b-plus';
                    else if (averageCurrentGPA >= 3.0) gradeClass = 'grade-b';
                    else if (averageCurrentGPA >= 2.67) gradeClass = 'grade-b-minus';
                    else if (averageCurrentGPA >= 2.33) gradeClass = 'grade-c-plus';
                    else if (averageCurrentGPA >= 2.0) gradeClass = 'grade-c';
                    else if (averageCurrentGPA >= 1.67) gradeClass = 'grade-c-minus';
                    else if (averageCurrentGPA >= 1.0) gradeClass = 'grade-d';
                    else gradeClass = 'grade-f';
                    
                    cumulativeGPADiv.innerHTML += `
                        <div style="margin-bottom: 10px;">
                            <strong>Current Semester GPA:</strong> 
                            <span class="${gradeClass}">${averageCurrentGPA}</span>, 
                            Percentage: ${averageCurrentPercentage}%
                        </div>
                    `;
                    totalQualityPoints += currentSemesterQualityPoints;
                    totalCredits += currentSemesterCredits;
                    totalPercentagePoints += currentSemesterPercentagePoints;
                }
            }

            // Final Cumulative
            const cumulativeGPA = totalCredits > 0 ? (totalQualityPoints / totalCredits).toFixed(2) : 'N/A';
            const cumulativePercentage = totalCredits > 0 ? (totalPercentagePoints / totalCredits).toFixed(2) : 'N/A';
            
            // Determine grade class for coloring
            let finalGradeClass = '';
            if (cumulativeGPA >= 4.33) finalGradeClass = 'grade-a-plus';
            else if (cumulativeGPA >= 4.0) finalGradeClass = 'grade-a';
            else if (cumulativeGPA >= 3.67) finalGradeClass = 'grade-a-minus';
            else if (cumulativeGPA >= 3.33) finalGradeClass = 'grade-b-plus';
            else if (cumulativeGPA >= 3.0) finalGradeClass = 'grade-b';
            else if (cumulativeGPA >= 2.67) finalGradeClass = 'grade-b-minus';
            else if (cumulativeGPA >= 2.33) finalGradeClass = 'grade-c-plus';
            else if (cumulativeGPA >= 2.0) finalGradeClass = 'grade-c';
            else if (cumulativeGPA >= 1.67) finalGradeClass = 'grade-c-minus';
            else if (cumulativeGPA >= 1.0) finalGradeClass = 'grade-d';
            else finalGradeClass = 'grade-f';
            
            cumulativeGPADiv.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; text-align: center;">
                    <h3>Cumulative GPA</h3>
                    <div class="${finalGradeClass}" style="font-size: 36px; font-weight: bold; margin: 10px 0;">${cumulativeGPA}</div>
                    <div>Percentage: ${cumulativePercentage}%</div>
                </div>
            `;
            
            // Current Semester Classes
            if (includeCurrentSemester) {
                classes.forEach(cls => {
                    let totalWeightedScore = 0;
                    let totalWeights = 0;
                    
                    cls.categories.forEach((cat, index) => {
                        const grades = cls.assignments
                            .filter(a => 
                                a.categoryIndex === index && 
                                !a.exclude && 
                                !isAssignmentDropped(cls, index, cls.assignments.indexOf(a)) && 
                                a.score !== null && 
                                a.total !== null
                            )
                            .map(a => (a.score / a.total) * 100);
                        
                        if (grades.length > 0) {
                            const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                            totalWeightedScore += (average * cat.weight);
                            totalWeights += cat.weight;
                        }
                    });
                    
                    if (totalWeights > 0) {
                        const finalGrade = (totalWeightedScore / totalWeights);
                        const gpa = getGPA(finalGrade);
                        
                        // Add to allClasses for comparison
                        allClasses.push({
                            name: cls.name,
                            semester: 'Current Semester',
                            gpa: gpa,
                            percentage: finalGrade,
                            credits: cls.credits,
                            letterGrade: getLetterGrade(finalGrade)
                        });
                    }
                });
            }
            
            // Course Comparison Dashboard
            if (allClasses.length > 0) {
                // Sort by GPA (best to worst)
                allClasses.sort((a, b) => b.gpa - a.gpa);
                
                allClasses.forEach(cls => {
                    // Determine grade class for coloring
                    let gradeClass = '';
                    if (cls.gpa >= 4.33) gradeClass = 'grade-a-plus';
                    else if (cls.gpa >= 4.0) gradeClass = 'grade-a';
                    else if (cls.gpa >= 3.67) gradeClass = 'grade-a-minus';
                    else if (cls.gpa >= 3.33) gradeClass = 'grade-b-plus';
                    else if (cls.gpa >= 3.0) gradeClass = 'grade-b';
                    else if (cls.gpa >= 2.67) gradeClass = 'grade-b-minus';
                    else if (cls.gpa >= 2.33) gradeClass = 'grade-c-plus';
                    else if (cls.gpa >= 2.0) gradeClass = 'grade-c';
                    else if (cls.gpa >= 1.67) gradeClass = 'grade-c-minus';
                    else if (cls.gpa >= 1.0) gradeClass = 'grade-d';
                    else gradeClass = 'grade-f';
                    
                    const courseCard = document.createElement('div');
                    courseCard.className = 'course-card';
                    
                    // Progress bar width based on GPA (0-4.33 scale)
                    const progressWidth = (cls.gpa / 4.33) * 100;
                    
                    // Add comparison metrics
                    let comparisonMetric = '';
                    let rank = null;
                    
                    if (allClasses.length > 1) {
                        // Find rank of this class
                        rank = allClasses.findIndex(c => c === cls) + 1;
                        const percentile = Math.round((allClasses.length - rank + 1) / allClasses.length * 100);
                        
                        // Calculate difference from average
                        const avgGPA = allClasses.reduce((sum, c) => sum + c.gpa, 0) / allClasses.length;
                        const diffFromAvg = cls.gpa - avgGPA;
                        
                        if (Math.abs(diffFromAvg) > 0.2) {
                            comparisonMetric = `<div style="margin-top: 5px; font-size: 12px; ${diffFromAvg > 0 ? 'color: #4caf50' : 'color: #f44336'}">
                                ${diffFromAvg > 0 ? '▲' : '▼'} 
                                ${Math.abs(diffFromAvg).toFixed(2)} points from average
                            </div>`;
                        }
                    }
                    
                    courseCard.innerHTML = `
                        <div class="credit-badge">${cls.credits} credits</div>
                        <div class="course-name">${cls.name}</div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${cls.semester}</div>
                        <div class="${gradeClass}" style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">
                            ${cls.letterGrade} (${cls.gpa.toFixed(2)})
                        </div>
                        <div style="width: 100%; background: #333; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${progressWidth}%; background: var(--accent-color); height: 100%; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px;">
                            <span>${cls.percentage.toFixed(1)}%</span>
                            <span>${rank ? 'Rank: ' + rank + ' of ' + allClasses.length : ''}</span>
                        </div>
                        ${comparisonMetric}
                    `;
                    
                    courseComparisonDiv.appendChild(courseCard);
                });
            } else {
                courseComparisonDiv.innerHTML = '<p>Add courses to see your performance comparison.</p>';
            }
        }

    </script>
</body>
</html>

