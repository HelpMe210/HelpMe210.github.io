<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grade Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 
           Dark, boyish theme. Blues & dark backgrounds.
           Mobile friendly enhancements.
           Better spacing on sidebar and buttons.
        */

        :root {
            --background-color: #1d1f21;
            --sidebar-color: #252729;
            --accent-color: #2f81f7;
            --text-color: #ffffff;
            --text-color-light: #cccccc;
            --border-color: #2c2f33;
            --error-color: #e74c3c;
            --success-color: #27ae60;
            --transition-speed: 0.3s;
            --table-row-hover: #2c2f33;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-color);
            color: var(--text-color-light);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        header {
            background: var(--sidebar-color);
            color: var(--text-color);
            padding: 10px 20px;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        header .title {
            flex: 1;
        }

        #container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR */
        #sidebar {
            width: 240px;
            background: var(--sidebar-color);
            color: var(--text-color);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding-bottom: 20px;
        }

        #sidebar h2 {
            text-align: center;
            padding: 20px 0;
            margin: 0;
            font-size: 22px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px;
        }

        .sidebar-button-group.bottom-buttons {
            margin-top: auto;
        }

        #class-list {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
        }

        #class-list li {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background var(--transition-speed);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #class-list li:hover, #class-list .active {
            background: #2c2f33;
        }

        /* CONTENT */
        #content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .button {
            padding: 8px 15px;
            background: var(--accent-color);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
            font-weight: 600;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed), background var(--transition-speed);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: inline-block;
        }

        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .button.small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .button.accent {
            background: var(--error-color);
        }

        .button.secondary {
            background: #3b3e42;
        }

        input[type="text"], input[type="number"], input[type="email"], input[type="password"], select, textarea {
            padding: 8px;
            width: 100%;
            margin: 5px 0 15px 0;
            border: 1px solid #444;
            border-radius: 5px;
            font-size: 14px;
            color: var(--text-color);
            background: #2c2f33;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        label {
            margin-bottom: 5px;
            display: block;
            font-weight: 600;
            color: var(--text-color-light);
        }

        section {
            margin-bottom: 30px;
            padding: 20px;
            background: #2c2f33;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }

        h2, h3, h4 {
            color: var(--text-color);
            margin-top: 0;
        }

        h2 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        h4 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        p, li {
            color: var(--text-color-light);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: #1f2123;
            border-radius: 10px;
            overflow: hidden;
            table-layout: auto; /* allow flexible cell sizes */
        }

        table, th, td {
            border: none;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
            vertical-align: top;
            color: var(--text-color-light);
            white-space: normal; /* allow multiline */
        }

        tr:hover {
            background-color: var(--table-row-hover);
        }

        /* Animate assignment row movement more clearly */
        tbody tr.move-animation {
            transition: transform 0.3s ease-in-out;
        }

        /* Excluded or dropped assignment row backgrounds */
        .excluded-manual {
            background-color: rgba(231, 76, 60, 0.3) !important;
        }

        .excluded-dropped {
            background-color: rgba(241, 196, 15, 0.3) !important;
        }

        .error {
            color: var(--error-color);
            font-weight: 600;
            margin-top: 10px;
            display: inline-block;
        }

        footer {
            text-align: center;
            padding: 10px 0;
            background: #252729;
            color: var(--text-color-light);
            border-top: 1px solid var(--border-color);
        }

        #login-container {
            padding:20px;
            max-width: 300px;
            margin: 100px auto;
            background: #2c2f33;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #admin-controls {
            margin-top: 20px;
            display: none;
            padding: 20px;
            background: #2c2f33;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            #sidebar {
                width: 200px;
            }

            .sidebar-button-group {
                margin: 10px;
            }
        }

        @media (max-width: 600px) {
            #sidebar {
                position: fixed;
                width: 100%;
                height: auto;
                z-index: 100;
                border-bottom: 1px solid var(--border-color);
            }

            #container {
                flex-direction: column;
            }

            #content {
                margin-left: 0 !important;
                padding-top: 80px; /* to avoid overlap with sidebar now on top */
            }

            #sidebar h2 {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="title">Grade Tracker</div>
        <div style="font-size:14px;">built by Reuven Sash</div>
    </header>
    <div id="login-container" style="display:none;">
        <h2>Login</h2>
        <label>Email</label>
        <input type="email" id="login-email" placeholder="Email" />
        <label>Password</label>
        <input type="password" id="login-password" placeholder="Password" />
        <button id="login-button" class="button">Login</button>
        <div id="login-error" class="error"></div>
    </div>
    <div id="container">
        <div id="sidebar" style="display:none;">
            <h2>Your Classes</h2>
            <div class="sidebar-button-group">
                <button id="add-class-btn" class="button">Add New Class</button>
                <button id="gpa-calculator-btn" class="button secondary">GPA Calculator</button>
            </div>
            <ul id="class-list"></ul>
            <div class="sidebar-button-group bottom-buttons">
                <button id="export-data-btn" class="button small">Export JSON</button>
                <button id="export-csv-btn" class="button small">Export CSV</button>
                <button id="import-data-btn" class="button small">Import Data</button>
                <input type="file" id="import-file-input" accept=".json,.csv" style="display:none;">
                <button id="logout-button" class="button accent small">Logout</button>
            </div>
            <div id="admin-controls">
                <h3>Admin Controls</h3>
                <label for="user-select">Select User</label>
                <select id="user-select"></select>
                <button id="switch-user-button" class="button">Load Selected User</button>
            </div>
        </div>

        <div id="content" style="display:none;"></div>
    </div>
    <footer>
        Built by Reuven Sash + ChatGPT
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // ===== Firebase Initialization =====
        const firebaseConfig = {
            apiKey: "AIzaSyCxpYrGFjIlHQovBD-44riu96AZ50L3YUo",
  authDomain: "yof-tracker.firebaseapp.com",
  projectId: "yof-tracker",
  storageBucket: "yof-tracker.firebasestorage.app",
  messagingSenderId: "867007397664",
  appId: "1:867007397664:web:9cbccc410443d6581a2145"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let docRef = null;
        let classes = [];
        let semesters = [];
        let dataLoaded = false;
        let currentUser = null;
        let isAdmin = false;

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                try {
                  const rolesDoc = await db.collection('adminInfo').doc('roles').get();
                  if (rolesDoc.exists) {
                    const data = rolesDoc.data();
                    isAdmin = Array.isArray(data.adminUsers) && data.adminUsers.includes(user.uid);
                  } else {
                    isAdmin = false;
                  }
                } catch (err) {
                  console.error("Error checking admin roles:", err);
                  isAdmin = false;
                }

                if (isAdmin) {
                    showAdminUI();
                } else {
                    docRef = db.collection('gradeTracker').doc(user.uid);
                    document.getElementById('admin-controls').style.display = 'none';
                    await loadDataFromFirestore();
                    showNormalUserUI();
                }
            } else {
                currentUser = null;
                docRef = null;
                showLoginUI();
            }
        });

        function showLoginUI() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('content').style.display = 'none';
            document.getElementById('admin-controls').style.display = 'none';
        }

        function showNormalUserUI() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('content').style.display = 'block';
        }

        async function showAdminUI() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('content').style.display = 'block';
            document.getElementById('admin-controls').style.display = 'block';

            const snapshot = await db.collection('gradeTracker').get();
            const userSelect = document.getElementById('user-select');
            userSelect.innerHTML = '<option value="">--Select a user--</option>';
            snapshot.forEach(doc => {
              const opt = document.createElement('option');
              opt.value = doc.id;
              opt.textContent = doc.id;
              userSelect.appendChild(opt);
            });
        }

        document.getElementById('login-button').onclick = async function() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                document.getElementById('login-error').textContent = error.message;
            }
        };

        document.getElementById('logout-button').onclick = async function() {
            await auth.signOut();
        };

        document.getElementById('switch-user-button').onclick = async function() {
          const selectedUserId = document.getElementById('user-select').value;
          if (!selectedUserId) {
            alert('Please select a user');
            return;
          }
          docRef = db.collection('gradeTracker').doc(selectedUserId);
          await loadDataFromFirestore();
        };

        async function loadDataFromFirestore() {
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const data = docSnap.data();
                classes = data.classes || [];
                semesters = data.semesters || [];
            } else {
                classes = [];
                semesters = [];
            }
            dataLoaded = true;
            renderClassList();
            if (classes.length > 0) {
                const firstClassLi = document.querySelector('#class-list li');
                if (firstClassLi) firstClassLi.classList.add('active');
                renderClassContent(0);
            } else {
                document.getElementById('content').innerHTML = '';
            }
        }

        async function saveData() {
            if (!dataLoaded || !docRef) return;
            await docRef.set({ classes, semesters });
        }

        /*============================
          CLASS LIST & MAIN CONTENT
        ============================*/

        function renderClassList() {
            const classList = document.getElementById('class-list');
            classList.innerHTML = '';
            classes.forEach((cls, index) => {
                const li = document.createElement('li');
                li.textContent = cls.name;
                li.onclick = () => {
                    document.querySelectorAll('#class-list li').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');
                    renderClassContent(index);
                };
                classList.appendChild(li);
            });
        }

        function renderClassContent(classIndex) {
            const content = document.getElementById('content');
            const cls = classes[classIndex];
            if (!cls.categories) cls.categories = [];

            // Check if categories total 100
            let totalWeight = cls.categories.reduce((sum, cat) => sum + Number(cat.weight), 0);
            let categoryWarning = '';
            if (totalWeight !== 100) {
                categoryWarning = `
                    <p class="error">
                        Warning: Categories total ${totalWeight}%. They should total 100% for accurate final grading.
                    </p>
                `;
            }

            content.innerHTML = `
                <h2>${cls.name}</h2>
                <div style="margin-bottom:20px;">
                    <button class="button" onclick="editClass(${classIndex})">Edit Class</button>
                    <button class="button accent small" onclick="deleteClass(${classIndex})">Delete</button>
                </div>
                <section>
                    <h3>Categories</h3>
                    ${categoryWarning}
                    <div id="category-list"></div>
                    <div style="margin-top:10px;">
                        <button class="button small" style="margin-top:10px;" onclick="addCategory(${classIndex})">Add Category</button>
                    </div>
                    <span id="category-error" class="error"></span>
                </section>
                <section>
                    <h3>Assignments</h3>
                    <div id="assignment-list"></div>
                    <button class="button" onclick="addAssignment(${classIndex})">Add Assignment</button>
                    <span id="assignment-error" class="error"></span>
                </section>
                <section id="grade-summary-section">
                    <h3>Current Grade</h3>
                    <div id="grade-summary"></div>
                </section>
            `;

            renderCategories(classIndex);
            renderAssignments(classIndex);
            calculateGrade(classIndex);
        }

        function addClass() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <section>
                    <h3>Add New Class</h3>
                    <label>Class Name</label>
                    <input type="text" id="new-class-name" placeholder="e.g., Mathematics">
                    <label>Credits (default is 1)</label>
                    <input type="number" id="new-class-credits" placeholder="e.g., 1" min="0.1" step="0.1">
                    <div style="margin-top:20px;">
                        <button class="button" onclick="saveNewClass()">Save</button>
                        <button class="button accent" onclick="renderClassContentOnCancel()">Cancel</button>
                    </div>
                </section>
            `;
        }

        function renderClassContentOnCancel() {
          if (classes.length > 0) {
              renderClassContent(0);
          } else {
              document.getElementById('content').innerHTML = '';
          }
        }

        async function saveNewClass() {
            const className = document.getElementById('new-class-name').value.trim();
            let classCredits = parseFloat(document.getElementById('new-class-credits').value);
            if (className === '') {
                alert('Please enter a valid class name.');
                return;
            }
            if (isNaN(classCredits) || classCredits <= 0) {
                classCredits = 1;
            }
            classes.push({
                name: className,
                credits: classCredits,
                categories: [],
                assignments: [],
                finalCategoryIndex: null
            });
            await saveData();
            renderClassList();
            const newIndex = classes.length - 1;
            document.querySelectorAll('#class-list li').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('#class-list li')[newIndex].classList.add('active');
            renderClassContent(newIndex);
        }

        function editClass(classIndex) {
            const cls = classes[classIndex];
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>Edit Class</h2>
                <label>Class Name</label>
                <input type="text" id="edit-class-name" value="${cls.name}">
                <label>Credits (default is 1)</label>
                <input type="number" id="edit-class-credits" value="${cls.credits}" min="0.1" step="0.1">
                <div style="margin-top:20px;">
                    <button class="button" onclick="saveEditedClass(${classIndex})">Save</button>
                    <button class="button accent" onclick="renderClassContent(${classIndex})">Cancel</button>
                </div>
            `;
        }

        async function saveEditedClass(classIndex) {
            const cls = classes[classIndex];
            const newName = document.getElementById('edit-class-name').value.trim();
            let newCredits = parseFloat(document.getElementById('edit-class-credits').value);
            if (newName === '') {
                alert('Please enter a valid class name.');
                return;
            }
            if (isNaN(newCredits) || newCredits <= 0) {
                newCredits = 1;
            }
            cls.name = newName;
            cls.credits = newCredits;
            await saveData();
            renderClassList();
            renderClassContent(classIndex);
        }

        async function deleteClass(classIndex) {
            if (confirm('Are you sure you want to delete this class?')) {
                classes.splice(classIndex, 1);
                await saveData();
                renderClassList();
                document.getElementById('content').innerHTML = '';
            }
        }

        /*============================
          CATEGORIES
        ============================*/

        function addCategory(classIndex) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';

            categoryDiv.innerHTML = `
                <label>Category Name</label>
                <input type="text" placeholder="e.g., Quizzes">
                <label>Weight (%)</label>
                <input type="number" placeholder="e.g., 20" min="0" max="100">
                <label>Number of Lowest Grades to Drop</label>
                <input type="number" placeholder="e.g., 1" min="0" step="1">
                <div style="margin-top:10px;">
                    <button class="button small" onclick="saveCategory(${classIndex}, this)">Save</button>
                    <button class="button accent small" onclick="renderCategories(${classIndex})">Cancel</button>
                </div>
            `;
            document.getElementById('category-list').appendChild(categoryDiv);
        }

        async function saveCategory(classIndex, button) {
            const cls = classes[classIndex];
            const categoryDiv = button.parentElement.parentElement;
            const inputs = categoryDiv.querySelectorAll('input');
            const name = inputs[0].value.trim();
            const weight = Number(inputs[1].value);
            let numToDrop = parseInt(inputs[2].value, 10);

            if (name === '' || isNaN(weight) || weight <= 0) {
                alert('Please enter valid category details.');
                return;
            }

            if (isNaN(numToDrop) || numToDrop < 0) {
                numToDrop = 0;
            }

            const totalWeight = cls.categories.reduce((sum, cat) => sum + Number(cat.weight), 0) + weight;
            if (totalWeight > 100) {
                alert('Total weight exceeds 100%. Adjust the weights.');
                return;
            }

            cls.categories.push({
                name: name,
                weight: weight,
                numToDrop: numToDrop
            });
            await saveData();
            renderCategories(classIndex);
            calculateGrade(classIndex);
        }

        function renderCategories(classIndex) {
            const cls = classes[classIndex];
            const categoryList = document.getElementById('category-list');
            categoryList.innerHTML = '';
            if (!cls.categories) cls.categories = [];
            cls.categories.forEach((cat, index) => {
                const div = document.createElement('div');
                div.className = 'category';
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <strong>${cat.name}</strong> - Weight: ${cat.weight}% 
                    ${cat.numToDrop > 0 ? `<em>(Drop Lowest ${cat.numToDrop})</em>` : ''}
                    <div style="margin-top:5px;">
                        <button class="button small" onclick="editCategory(${classIndex}, ${index})">Edit</button>
                        <button class="button accent small" onclick="deleteCategory(${classIndex}, ${index})">Delete</button>
                    </div>
                `;
                categoryList.appendChild(div);
            });
        }

        function editCategory(classIndex, categoryIndex) {
            const cls = classes[classIndex];
            const cat = cls.categories[categoryIndex];

            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';

            categoryDiv.innerHTML = `
                <label>Category Name</label>
                <input type="text" value="${cat.name}">
                <label>Weight (%)</label>
                <input type="number" min="0" max="100" value="${cat.weight}">
                <label>Number of Lowest Grades to Drop</label>
                <input type="number" min="0" step="1" value="${cat.numToDrop || 0}">
                <div style="margin-top:10px;">
                    <button class="button small" onclick="saveEditedCategory(${classIndex}, ${categoryIndex}, this)">Save</button>
                    <button class="button accent small" onclick="renderCategories(${classIndex})">Cancel</button>
                </div>
            `;

            const categoryList = document.getElementById('category-list');
            categoryList.replaceChild(categoryDiv, categoryList.children[categoryIndex]);
        }

        async function saveEditedCategory(classIndex, categoryIndex, button) {
            const cls = classes[classIndex];
            const cat = cls.categories[categoryIndex];
            const categoryDiv = button.parentElement.parentElement;
            const inputs = categoryDiv.querySelectorAll('input');
            const name = inputs[0].value.trim();
            const weight = Number(inputs[1].value);
            let numToDrop = parseInt(inputs[2].value, 10);

            if (name === '' || isNaN(weight) || weight <= 0) {
                alert('Please enter valid category details.');
                return;
            }

            if (isNaN(numToDrop) || numToDrop < 0) {
                numToDrop = 0;
            }

            const totalWeight = cls.categories.reduce((sum, c, i) => sum + (i !== categoryIndex ? Number(c.weight) : 0), 0) + weight;
            if (totalWeight > 100) {
                alert('Total weight exceeds 100%. Adjust the weights.');
                return;
            }

            cat.name = name;
            cat.weight = weight;
            cat.numToDrop = numToDrop;
            await saveData();
            renderCategories(classIndex);
            calculateGrade(classIndex);
        }

        async function deleteCategory(classIndex, categoryIndex) {
            if (confirm('Deleting this category will also delete all associated assignments. Proceed?')) {
                const cls = classes[classIndex];
                cls.categories.splice(categoryIndex, 1);

                // Remove assignments from this category
                cls.assignments = cls.assignments.filter(a => a.categoryIndex !== categoryIndex);

                // Re-index other assignments
                cls.assignments.forEach(a => {
                    if (a.categoryIndex > categoryIndex) a.categoryIndex--;
                });

                if (cls.finalCategoryIndex === categoryIndex) {
                    cls.finalCategoryIndex = null;
                } else if (cls.finalCategoryIndex > categoryIndex) {
                    cls.finalCategoryIndex--;
                }
                await saveData();
                renderCategories(classIndex);
                renderAssignments(classIndex);
                calculateGrade(classIndex);
            }
        }

        /*============================
          ASSIGNMENTS
        ============================*/

        function addAssignment(classIndex) {
            const cls = classes[classIndex];
            if (cls.categories.length === 0) {
                alert('Please add at least one category first.');
                return;
            }
            const categoryOptions = cls.categories.map((cat, index) => `<option value="${index}">${cat.name}</option>`).join('');
            const assignmentHTML = `
                <div class="assignment" style="margin-top:10px;">
                    <label>Assignment Name</label>
                    <input type="text" placeholder="e.g., Quiz 1">
                    <label>Category</label>
                    <select>
                        ${categoryOptions}
                    </select>
                    <label>Score (or leave blank if incomplete) e.g. 18/25</label>
                    <input type="text" placeholder="e.g., 18/25">
                    <label style="margin-top:5px;">
                        <input type="checkbox"> Exclude from Grade
                    </label>
                    <div style="margin-top:10px;">
                        <button class="button small" onclick="saveAssignment(${classIndex}, this)">Save</button>
                        <button class="button accent small" onclick="renderAssignments(${classIndex})">Cancel</button>
                    </div>
                </div>
            `;
            document.getElementById('assignment-list').insertAdjacentHTML('beforeend', assignmentHTML);
        }

        async function saveAssignment(classIndex, button) {
            const cls = classes[classIndex];
            const assignmentDiv = button.parentElement.parentElement;
            const inputs = assignmentDiv.querySelectorAll('input');
            const selects = assignmentDiv.querySelectorAll('select');
            const name = inputs[0].value.trim();
            const categoryIndex = Number(selects[0].value);
            const gradeInput = inputs[1].value.trim();
            const exclude = inputs[2].checked;

            let score = null;
            let total = null;
            if (gradeInput && gradeInput.includes('/')) {
                const parts = gradeInput.split('/');
                score = Number(parts[0]);
                total = Number(parts[1]);
                if (isNaN(score) || isNaN(total) || total === 0) {
                    alert('Invalid score format.');
                    return;
                }
            }

            if (name === '') {
                alert('Please enter a valid assignment name.');
                return;
            }

            cls.assignments.push({
                name: name,
                categoryIndex: categoryIndex,
                score: score,
                total: total,
                exclude: exclude
            });
            await saveData();
            renderAssignments(classIndex);
            calculateGrade(classIndex);
        }

        function renderAssignments(classIndex) {
            const cls = classes[classIndex];
            const assignmentList = document.getElementById('assignment-list');
            assignmentList.innerHTML = '';
            if (!cls.assignments || cls.assignments.length === 0) {
                assignmentList.innerHTML = '<p>No assignments added yet.</p>';
                return;
            }

            const table = document.createElement('table');
            let thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Score</th>
                    <th>Total</th>
                    <th>Percentage</th>
                    <th>Actions</th>
                </tr>
            `;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);

            cls.assignments.forEach((assignment, index) => {
                const catName = cls.categories[assignment.categoryIndex].name;
                let percentage = '';
                if (assignment.score !== null && assignment.total !== null) {
                    percentage = ((assignment.score / assignment.total) * 100).toFixed(2) + '%';
                } else {
                    percentage = '<em>Incomplete</em>';
                }

                const tr = document.createElement('tr');

                // Exclude / dropped highlight
                if (assignment.exclude) {
                    tr.classList.add('excluded-manual');
                } else if (isAssignmentDropped(cls, assignment.categoryIndex, index)) {
                    tr.classList.add('excluded-dropped');
                }

                tr.innerHTML = `
                    <td>${assignment.name} ${assignment.exclude ? '<em>(Excluded)</em>' : ''}</td>
                    <td>${catName}</td>
                    <td>${assignment.score === null ? '—' : assignment.score}</td>
                    <td>${assignment.total === null ? '—' : assignment.total}</td>
                    <td>${percentage}</td>
                    <td>
                        <button class="button small" onclick="editAssignment(${classIndex}, ${index})">Edit</button>
                        <button class="button accent small" onclick="deleteAssignment(${classIndex}, ${index})">Delete</button>
                        <button class="button small" onclick="moveAssignmentUp(${classIndex}, ${index})" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="button small" onclick="moveAssignmentDown(${classIndex}, ${index})" ${index === cls.assignments.length - 1 ? 'disabled' : ''}>↓</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            assignmentList.appendChild(table);
        }

        async function moveAssignmentUp(classIndex, assignmentIndex) {
            const cls = classes[classIndex];
            if (assignmentIndex > 0) {
                // Grab table rows to animate
                const tbody = document.querySelector('#assignment-list tbody');
                const rows = tbody.querySelectorAll('tr');
                rows[assignmentIndex].classList.add('move-animation');
                rows[assignmentIndex - 1].classList.add('move-animation');

                // Reorder in array
                const temp = cls.assignments[assignmentIndex];
                cls.assignments[assignmentIndex] = cls.assignments[assignmentIndex - 1];
                cls.assignments[assignmentIndex - 1] = temp;

                await saveData();
                renderAssignments(classIndex);
            }
        }

        async function moveAssignmentDown(classIndex, assignmentIndex) {
            const cls = classes[classIndex];
            if (assignmentIndex < cls.assignments.length - 1) {
                // Grab table rows to animate
                const tbody = document.querySelector('#assignment-list tbody');
                const rows = tbody.querySelectorAll('tr');
                rows[assignmentIndex].classList.add('move-animation');
                rows[assignmentIndex + 1].classList.add('move-animation');

                // Reorder in array
                const temp = cls.assignments[assignmentIndex];
                cls.assignments[assignmentIndex] = cls.assignments[assignmentIndex + 1];
                cls.assignments[assignmentIndex + 1] = temp;

                await saveData();
                renderAssignments(classIndex);
            }
        }

        function editAssignment(classIndex, assignmentIndex) {
            const cls = classes[classIndex];
            const assignment = cls.assignments[assignmentIndex];

            const categoryOptions = cls.categories.map((cat, index) => `<option value="${index}" ${index === assignment.categoryIndex ? 'selected' : ''}>${cat.name}</option>`).join('');

            const assignmentList = document.getElementById('assignment-list');
            const table = assignmentList.querySelector('table');
            const rows = table.querySelectorAll('tbody tr');
            const assignmentRow = rows[assignmentIndex];

            const editRow = document.createElement('tr');
            let scoreText = '';
            if (assignment.score !== null && assignment.total !== null) {
                scoreText = `${assignment.score}/${assignment.total}`;
            }

            editRow.innerHTML = `
                <td colspan="6">
                    <div class="assignment">
                        <label>Assignment Name</label>
                        <input type="text" value="${assignment.name}">
                        <label>Category</label>
                        <select>
                            ${categoryOptions}
                        </select>
                        <label>Score (blank if incomplete)</label>
                        <input type="text" value="${scoreText}">
                        <label style="margin-top:5px;">
                            <input type="checkbox" ${assignment.exclude ? 'checked' : ''}> Exclude from Grade
                        </label>
                        <div style="margin-top:10px;">
                            <button class="button small" onclick="saveEditedAssignment(${classIndex}, ${assignmentIndex}, this)">Save</button>
                            <button class="button accent small" onclick="renderAssignments(${classIndex})">Cancel</button>
                        </div>
                    </div>
                </td>
            `;
            table.querySelector('tbody').replaceChild(editRow, assignmentRow);
        }

        async function saveEditedAssignment(classIndex, assignmentIndex, button) {
            const cls = classes[classIndex];
            const assignment = cls.assignments[assignmentIndex];
            const assignmentDiv = button.parentElement.parentElement;
            const inputs = assignmentDiv.querySelectorAll('input');
            const selects = assignmentDiv.querySelectorAll('select');
            const name = inputs[0].value.trim();
            const categoryIndex = Number(selects[0].value);
            const gradeInput = inputs[1].value.trim();
            const exclude = inputs[2].checked;

            let score = null;
            let total = null;
            if (gradeInput && gradeInput.includes('/')) {
                const parts = gradeInput.split('/');
                score = Number(parts[0]);
                total = Number(parts[1]);
                if (isNaN(score) || isNaN(total) || total === 0) {
                    alert('Invalid score format.');
                    return;
                }
            }

            if (name === '') {
                alert('Please enter a valid assignment name.');
                return;
            }

            assignment.name = name;
            assignment.categoryIndex = categoryIndex;
            assignment.score = score;
            assignment.total = total;
            assignment.exclude = exclude;
            await saveData();
            renderAssignments(classIndex);
            calculateGrade(classIndex);
        }

        async function deleteAssignment(classIndex, assignmentIndex) {
            if (confirm('Are you sure you want to delete this assignment?')) {
                const cls = classes[classIndex];
                cls.assignments.splice(assignmentIndex, 1);
                await saveData();
                renderAssignments(classIndex);
                calculateGrade(classIndex);
            }
        }

        /*============================
          GRADE CALCULATION
        ============================*/

        function isAssignmentDropped(cls, categoryIndex, assignmentIndex) {
            const cat = cls.categories[categoryIndex];
            const numToDrop = cat.numToDrop || 0;
            if (numToDrop <= 0) return false;

            const assignmentsInCategory = cls.assignments
                .map((a, i) => ({...a, index: i}))
                .filter(a => a.categoryIndex === categoryIndex && !a.exclude && a.score !== null && a.total !== null);

            if (assignmentsInCategory.length <= numToDrop) return false;

            assignmentsInCategory.sort((a, b) => {
                const aPerc = a.score / a.total;
                const bPerc = b.score / b.total;
                return aPerc - bPerc;
            });

            const droppedAssignments = assignmentsInCategory.slice(0, numToDrop);
            return droppedAssignments.some(a => a.index === assignmentIndex);
        }

        // === The letter-grade scale with .5 cutoffs (the old scale) ===
        // A+: >= 96.5
        // A : >= 92.5
        // A-: >= 89.5
        // B+: >= 86.5
        // B : >= 82.5
        // B-: >= 79.5
        // C+: >= 76.5
        // C : >= 72.5
        // C-: >= 69.5
        // D : >= 64.5
        // F : below 64.5

        function calculateGrade(classIndex) {
            const cls = classes[classIndex];

            const categoryGrades = {};
            cls.categories.forEach((cat, index) => {
                categoryGrades[index] = [];
            });

            cls.assignments.forEach((assignment, index) => {
                if (
                    !assignment.exclude && 
                    !isAssignmentDropped(cls, assignment.categoryIndex, index) && 
                    assignment.score !== null && 
                    assignment.total !== null
                ) {
                    categoryGrades[assignment.categoryIndex].push((assignment.score / assignment.total) * 100);
                }
            });

            let totalWeightedScore = 0;
            let totalWeights = 0;
            let categoryAverages = {};

            cls.categories.forEach((cat, index) => {
                const grades = categoryGrades[index];
                if (grades && grades.length > 0) {
                    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                    totalWeightedScore += (average * cat.weight);
                    totalWeights += cat.weight;
                    categoryAverages[cat.name] = average.toFixed(2) + '%';
                } else {
                    categoryAverages[cat.name] = 'No Assignments';
                }
            });

            const finalGrade = totalWeights > 0 ? (totalWeightedScore / totalWeights).toFixed(2) : 0;
            const letterGrade = getLetterGrade(finalGrade);
            const gpaScale = getGPA(finalGrade).toFixed(2);

            const gradeSummary = document.getElementById('grade-summary');
            let categoryAverageHTML = '<h4>Category Averages:</h4><ul>';
            for (const [catName, avg] of Object.entries(categoryAverages)) {
                categoryAverageHTML += `<li>${catName}: ${avg}</li>`;
            }
            categoryAverageHTML += '</ul>';

            gradeSummary.innerHTML = `
                <p>Your current grade is: <strong>${finalGrade}% (${letterGrade}, GPA: ${gpaScale})</strong></p>
                ${categoryAverageHTML}
            `;
        }

        function getLetterGrade(percentage) {
            percentage = Number(percentage);
            if (percentage >= 96.5) return 'A+';
            if (percentage >= 92.5) return 'A';
            if (percentage >= 89.5) return 'A-';
            if (percentage >= 86.5) return 'B+';
            if (percentage >= 82.5) return 'B';
            if (percentage >= 79.5) return 'B-';
            if (percentage >= 76.5) return 'C+';
            if (percentage >= 72.5) return 'C';
            if (percentage >= 69.5) return 'C-';
            if (percentage >= 64.5) return 'D';
            return 'F';
        }

        function getGPA(percentage) {
            percentage = Number(percentage);
            if (percentage >= 96.5) return 4.0;
            if (percentage >= 92.5) return 3.7;
            if (percentage >= 89.5) return 3.3;
            if (percentage >= 86.5) return 3.0;
            if (percentage >= 82.5) return 2.7;
            if (percentage >= 79.5) return 2.3;
            if (percentage >= 76.5) return 2.0;
            if (percentage >= 72.5) return 1.7;
            if (percentage >= 69.5) return 1.3;
            if (percentage >= 64.5) return 1.0;
            return 0.0;
        }

        function getPercentageFromGPA(gpa) {
            // Approximate midpoints for display (matching the old scale)
            // Note: These are just used in the GPA Calculator summary 
            // to show an approximate "percentage" from a GPA value.
            if (gpa === 4.0) return 98;    // A+
            if (gpa === 3.7) return 94;    // A
            if (gpa === 3.3) return 90;    // A-
            if (gpa === 3.0) return 87;    // B+
            if (gpa === 2.7) return 84;    // B
            if (gpa === 2.3) return 80;    // B-
            if (gpa === 2.0) return 77;    // C+
            if (gpa === 1.7) return 74;    // C
            if (gpa === 1.3) return 70;    // C-
            if (gpa === 1.0) return 65;    // D
            return 60;                     // F
        }

        function getLetterGradeFromGPA(gpa) {
            gpa = Number(gpa);
            if (gpa === 4.0) return 'A+';
            if (gpa === 3.7) return 'A';
            if (gpa === 3.3) return 'A-';
            if (gpa === 3.0) return 'B+';
            if (gpa === 2.7) return 'B';
            if (gpa === 2.3) return 'B-';
            if (gpa === 2.0) return 'C+';
            if (gpa === 1.7) return 'C';
            if (gpa === 1.3) return 'C-';
            if (gpa === 1.0) return 'D';
            return 'F';
        }

        /*============================
          EXPORT / IMPORT
        ============================*/
        document.getElementById('export-data-btn').onclick = function() {
            const data = {
                classes: classes,
                semesters: semesters
            };
            const dataStr = JSON.stringify(data);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = 'grade_tracker_data.json';

            let linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        document.getElementById('export-csv-btn').onclick = function() {
            // Simple CSV export of classes and assignments
            let csv = "Class,Category,Assignment,Score,Total,Excluded\n";
            classes.forEach(cls => {
                cls.assignments.forEach(a => {
                    const catName = cls.categories[a.categoryIndex] ? cls.categories[a.categoryIndex].name : '';
                    csv += `"${cls.name}","${catName}","${a.name}",${a.score !== null ? a.score : ''},${a.total !== null ? a.total : ''},${a.exclude}\n`;
                });
            });

            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'grade_tracker_data.csv');
            link.click();
        };

        document.getElementById('import-data-btn').onclick = function() {
            document.getElementById('import-file-input').click();
        };

        document.getElementById('import-file-input').onchange = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;
                    let importedData;
                    if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(text);
                    } else if (file.name.endsWith('.csv')) {
                        // CSV import: Just as a naive example
                        const lines = text.split('\n').filter(l=>l.trim()!=='');
                        // first line is header
                        const classMap = {};

                        lines.slice(1).forEach(line=>{
                            const [clsName, catName, aName, score, total, exclude] = line.split(',');
                            const cName = clsName.replace(/"/g,'');
                            if(!classMap[cName]) {
                                classMap[cName] = {
                                    name: cName,
                                    credits: 1,
                                    categories: [],
                                    assignments: [],
                                    finalCategoryIndex: null
                                };
                            }
                            let catIndex = -1;
                            const realCatName = catName.replace(/"/g,'');
                            if (realCatName) {
                                catIndex = classMap[cName].categories.findIndex(c => c.name === realCatName);
                                if (catIndex === -1) {
                                    classMap[cName].categories.push({name: realCatName, weight:0, numToDrop:0});
                                    catIndex = classMap[cName].categories.length - 1;
                                }
                            } else {
                                // If no category given
                                catIndex = 0;
                                if (classMap[cName].categories.length === 0) {
                                    classMap[cName].categories.push({name: "Uncategorized", weight:0, numToDrop:0});
                                }
                            }
                            classMap[cName].assignments.push({
                                name: aName.replace(/"/g,''),
                                categoryIndex: catIndex,
                                score: score===''?null:Number(score),
                                total: total===''?null:Number(total),
                                exclude: exclude==='true'
                            });
                        });

                        importedData = {
                            classes: Object.values(classMap),
                            semesters: []
                        };
                    } else {
                        throw new Error('Unsupported file format.');
                    }

                    if (importedData.classes && importedData.semesters) {
                        classes = importedData.classes;
                        semesters = importedData.semesters;
                        await saveData();
                        renderClassList();
                        document.getElementById('content').innerHTML = '';
                        alert('Data imported successfully.');
                    } else {
                        throw new Error('Invalid data format.');
                    }
                } catch (error) {
                    alert('Failed to import data: ' + error.message);
                }
            };
            reader.readAsText(file);
        };

        /*============================
          GPA CALCULATOR
        ============================*/
        document.getElementById('gpa-calculator-btn').onclick = function() {
            renderGPACalculator();
        };

        function renderGPACalculator() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>GPA Calculator</h2>
                <section id="gpa-calculator-section">
                    <div id="semester-list"></div>
                    <button class="button" onclick="addSemester()">Add Semester</button>
                    <label style="display: block; margin-top: 15px;">
                        <input type="checkbox" id="include-current-semester" checked onchange="calculateCumulativeGPA()"> Include Current Semester in Cumulative GPA
                    </label>
                </section>
                <section id="cumulative-gpa-summary"></section>
            `;

            renderSemesters();
            calculateCumulativeGPA();
        }

        function addSemester() {
            const semesterDiv = document.createElement('div');
            semesterDiv.className = 'semester';
            semesterDiv.innerHTML = `
                <label>Semester Name</label>
                <input type="text" placeholder="e.g., Fall 2023">
                <div style="margin-top:10px;">
                    <button class="button small" onclick="saveSemester(this)">Save</button>
                    <button class="button accent small" onclick="this.parentElement.parentElement.remove()">Cancel</button>
                </div>
            `;
            document.getElementById('semester-list').appendChild(semesterDiv);
        }

        async function saveSemester(button) {
            const semesterDiv = button.parentElement.parentElement;
            const input = semesterDiv.querySelector('input');
            const name = input.value.trim();
            if (name === '') {
                alert('Please enter a valid semester name.');
                return;
            }

            semesters.push({
                name: name,
                classes: []
            });
            await saveData();
            renderSemesters();
            calculateCumulativeGPA();
        }

        function renderSemesters() {
            const semesterList = document.getElementById('semester-list');
            semesterList.innerHTML = '';
            semesters.forEach((semester, sIndex) => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'semester';
                semesterDiv.style.marginBottom = '20px';
                semesterDiv.innerHTML = `
                    <h3>${semester.name}</h3>
                    <div id="class-list-${sIndex}"></div>
                    <div style="margin-top:10px;">
                        <button class="button small" onclick="addClassToSemester(${sIndex})">Add Class</button>
                        <button class="button accent small" onclick="deleteSemester(${sIndex})">Delete Semester</button>
                    </div>
                    <hr>
                `;
                semesterList.appendChild(semesterDiv);
                renderClassesInSemester(sIndex);
            });
        }

        function addClassToSemester(sIndex) {
            const classDiv = document.createElement('div');
            classDiv.className = 'class';
            classDiv.innerHTML = `
                <label>Class Name</label>
                <input type="text" placeholder="e.g., Chemistry">
                <label>Credits (default is 1)</label>
                <input type="number" placeholder="e.g., 1" min="0.1" step="0.1">
                <label>Letter Grade</label>
                <select>
                    <option value="4.0">A+</option>
                    <option value="3.7">A</option>
                    <option value="3.3">A-</option>
                    <option value="3.0">B+</option>
                    <option value="2.7">B</option>
                    <option value="2.3">B-</option>
                    <option value="2.0">C+</option>
                    <option value="1.7">C</option>
                    <option value="1.3">C-</option>
                    <option value="1.0">D</option>
                    <option value="0.0">F</option>
                </select>
                <div style="margin-top:10px;">
                    <button class="button small" onclick="saveClassInSemester(${sIndex}, this)">Save</button>
                    <button class="button accent small" onclick="this.parentElement.parentElement.remove()">Cancel</button>
                </div>
            `;
            document.getElementById(`class-list-${sIndex}`).appendChild(classDiv);
        }

        async function saveClassInSemester(sIndex, button) {
            const semester = semesters[sIndex];
            const classDiv = button.parentElement.parentElement;
            const inputs = classDiv.querySelectorAll('input');
            const selects = classDiv.querySelectorAll('select');
            const name = inputs[0].value.trim();
            let credits = parseFloat(inputs[1].value);
            const gpa = Number(selects[0].value);
            const letterGrade = getLetterGradeFromGPA(gpa);

            if (name === '') {
                alert('Please enter a valid class name.');
                return;
            }
            if (isNaN(credits) || credits <= 0) {
                credits = 1;
            }

            semester.classes.push({
                name: name,
                credits: credits,
                gpa: gpa.toFixed(2),
                letterGrade: letterGrade
            });
            await saveData();
            renderClassesInSemester(sIndex);
            calculateCumulativeGPA();
        }

        function renderClassesInSemester(sIndex) {
            const semester = semesters[sIndex];
            const classListDiv = document.getElementById(`class-list-${sIndex}`);
            classListDiv.innerHTML = '';
            semester.classes.forEach((cls, cIndex) => {
                const div = document.createElement('div');
                div.className = 'class';
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <strong>${cls.name}</strong> - ${cls.letterGrade} (GPA: ${cls.gpa}, Credits: ${cls.credits})
                    <div style="margin-top:5px;">
                        <button class="button small" onclick="editClassInSemester(${sIndex}, ${cIndex})">Edit</button>
                        <button class="button accent small" onclick="deleteClassInSemester(${sIndex}, ${cIndex})">Delete</button>
                    </div>
                `;
                classListDiv.appendChild(div);
            });
        }

        function editClassInSemester(sIndex, cIndex) {
            const semester = semesters[sIndex];
            const cls = semester.classes[cIndex];

            const classDiv = document.createElement('div');
            classDiv.className = 'class';
            classDiv.innerHTML = `
                <label>Class Name</label>
                <input type="text" value="${cls.name}">
                <label>Credits (default is 1)</label>
                <input type="number" value="${cls.credits}" min="0.1" step="0.1">
                <label>Letter Grade</label>
                <select>
                    <option value="4.0"  ${cls.gpa === '4.00' ? 'selected' : ''}>A+</option>
                    <option value="3.7"  ${cls.gpa === '3.70' ? 'selected' : ''}>A</option>
                    <option value="3.3"  ${cls.gpa === '3.30' ? 'selected' : ''}>A-</option>
                    <option value="3.0"  ${cls.gpa === '3.00' ? 'selected' : ''}>B+</option>
                    <option value="2.7"  ${cls.gpa === '2.70' ? 'selected' : ''}>B</option>
                    <option value="2.3"  ${cls.gpa === '2.30' ? 'selected' : ''}>B-</option>
                    <option value="2.0"  ${cls.gpa === '2.00' ? 'selected' : ''}>C+</option>
                    <option value="1.7"  ${cls.gpa === '1.70' ? 'selected' : ''}>C</option>
                    <option value="1.3"  ${cls.gpa === '1.30' ? 'selected' : ''}>C-</option>
                    <option value="1.0"  ${cls.gpa === '1.00' ? 'selected' : ''}>D</option>
                    <option value="0.0"  ${cls.gpa === '0.00' ? 'selected' : ''}>F</option>
                </select>
                <div style="margin-top:10px;">
                    <button class="button small" onclick="saveEditedClassInSemester(${sIndex}, ${cIndex}, this)">Save</button>
                    <button class="button accent small" onclick="renderClassesInSemester(${sIndex})">Cancel</button>
                </div>
            `;

            const classListDiv = document.getElementById(`class-list-${sIndex}`);
            classListDiv.replaceChild(classDiv, classListDiv.children[cIndex]);
        }

        async function saveEditedClassInSemester(sIndex, cIndex, button) {
            const semester = semesters[sIndex];
            const cls = semester.classes[cIndex];
            const classDiv = button.parentElement.parentElement;
            const inputs = classDiv.querySelectorAll('input');
            const selects = classDiv.querySelectorAll('select');
            const name = inputs[0].value.trim();
            let credits = parseFloat(inputs[1].value);
            const gpa = Number(selects[0].value);
            const letterGrade = getLetterGradeFromGPA(gpa);

            if (name === '') {
                alert('Please enter a valid class name.');
                return;
            }
            if (isNaN(credits) || credits <= 0) {
                credits = 1;
            }

            cls.name = name;
            cls.credits = credits;
            cls.gpa = gpa.toFixed(2);
            cls.letterGrade = letterGrade;
            await saveData();
            renderClassesInSemester(sIndex);
            calculateCumulativeGPA();
        }

        async function deleteClassInSemester(sIndex, cIndex) {
            if (confirm('Are you sure you want to delete this class?')) {
                const semester = semesters[sIndex];
                semester.classes.splice(cIndex, 1);
                await saveData();
                renderClassesInSemester(sIndex);
                calculateCumulativeGPA();
            }
        }

        async function deleteSemester(sIndex) {
            if (confirm('Are you sure you want to delete this semester?')) {
                semesters.splice(sIndex, 1);
                await saveData();
                renderSemesters();
                calculateCumulativeGPA();
            }
        }

        function calculateCumulativeGPA() {
            let totalQualityPoints = 0;
            let totalCredits = 0;
            let totalPercentagePoints = 0;
            const cumulativeGPADiv = document.getElementById('cumulative-gpa-summary');
            cumulativeGPADiv.innerHTML = '';

            const includeCurrentSemester = document.getElementById('include-current-semester') ? document.getElementById('include-current-semester').checked : true;

            // Past Semesters
            semesters.forEach(semester => {
                let semesterQualityPoints = 0;
                let semesterCredits = 0;
                let semesterPercentagePoints = 0;
                semester.classes.forEach(cls => {
                    const numericGPA = Number(cls.gpa);
                    semesterQualityPoints += numericGPA * cls.credits;
                    semesterCredits += cls.credits;
                    const percentage = getPercentageFromGPA(numericGPA);
                    semesterPercentagePoints += percentage * cls.credits;
                });

                totalQualityPoints += semesterQualityPoints;
                totalCredits += semesterCredits;
                totalPercentagePoints += semesterPercentagePoints;

                const averageSemesterGPA = semesterCredits > 0 ? (semesterQualityPoints / semesterCredits).toFixed(2) : 'N/A';
                const averageSemesterPercentage = semesterCredits > 0 ? (semesterPercentagePoints / semesterCredits).toFixed(2) : 'N/A';

                cumulativeGPADiv.innerHTML += `
                    <h4>${semester.name} GPA: ${averageSemesterGPA}, Percentage: ${averageSemesterPercentage}%</h4>
                `;
            });

            // Current Semester
            if (includeCurrentSemester) {
                let currentSemesterQualityPoints = 0;
                let currentSemesterCredits = 0;
                let currentSemesterPercentagePoints = 0;

                classes.forEach(cls => {
                    let totalWeightedScore = 0;
                    let totalWeights = 0;

                    cls.categories.forEach((cat, index) => {
                        const grades = cls.assignments
                            .filter(a => 
                                a.categoryIndex === index && 
                                !a.exclude && 
                                !isAssignmentDropped(cls, index, cls.assignments.indexOf(a)) && 
                                a.score !== null && 
                                a.total !== null
                            )
                            .map(a => (a.score / a.total) * 100);

                        if (grades.length > 0) {
                            const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                            totalWeightedScore += (average * cat.weight);
                            totalWeights += cat.weight;
                        }
                    });

                    const finalGrade = totalWeights > 0 ? (totalWeightedScore / totalWeights) : 0;
                    const gpa = getGPA(finalGrade);
                    currentSemesterQualityPoints += gpa * cls.credits;
                    currentSemesterCredits += cls.credits;
                    currentSemesterPercentagePoints += finalGrade * cls.credits;
                });

                if (currentSemesterCredits > 0) {
                    const averageCurrentGPA = (currentSemesterQualityPoints / currentSemesterCredits).toFixed(2);
                    const averageCurrentPercentage = (currentSemesterPercentagePoints / currentSemesterCredits).toFixed(2);
                    cumulativeGPADiv.innerHTML += `
                        <h4>Current Semester GPA: ${averageCurrentGPA}, Percentage: ${averageCurrentPercentage}%</h4>
                    `;
                    totalQualityPoints += currentSemesterQualityPoints;
                    totalCredits += currentSemesterCredits;
                    totalPercentagePoints += currentSemesterPercentagePoints;
                }
            }

            // Final Cumulative
            const cumulativeGPA = totalCredits > 0 ? (totalQualityPoints / totalCredits).toFixed(2) : 'N/A';
            const cumulativePercentage = totalCredits > 0 ? (totalPercentagePoints / totalCredits).toFixed(2) : 'N/A';
            cumulativeGPADiv.innerHTML += `
                <h3>Cumulative GPA: ${cumulativeGPA}, Percentage: ${cumulativePercentage}%</h3>
            `;
        }

        document.getElementById('add-class-btn').onclick = addClass;
    </script>
</body>
</html>